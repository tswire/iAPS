var freeaps_determineBasal;(()=>{var e={5546:(e,r,a)=>{var t=a(6880);function o(e,r){r||(r=0);var a=Math.pow(10,r);return Math.round(e*a)/a}function n(e,r){return"mmol/L"===r.out_units?o(.0555*e,1):Math.round(e)}var i="",s="",l="",u="",m="",d="",c="",p="",b="",f="",g="",h="",B="",v=1,_=1,M=1,S=1,x=1,y=1,I=100;function T(e,r,a,t,i){if(void 0===a)return rT.error="Error: iob_data undefined. ",rT;var l=a;if(a.length,a.length>1&&(a=l[0]),void 0===a.activity||void 0===a.iob)return rT.error="Error: iob_data missing some property. ",rT;if(!t)return s=", autoISF-SMB disabled:, B30 running","AIMI B30";if(!e)return"oref";var u=n(r.min_bg,r);if(r.use_autoisf&&r.temptargetSet&&r.enableSMB_EvenOn_OddOff||r.use_autoisf&&r.min_bg==r.max_bg&&r.enableSMB_EvenOn_OddOff_always&&!r.temptargetSet){r.temptargetSet?msgType="TempTarget ":msgType="ProfileTarget ","mmol/L"==r.out_units?(evenTarget=o(10*u,0)%2==0,msgUnits=" has ",msgTail=" decimal"):(evenTarget=u%2==0,msgUnits=" is ",msgTail=" number"),evenTarget?msgEven="even":msgEven="odd",r.iob_threshold_percent<100&&r.iob_threshold_percent>0&&(I=r.iob_threshold_percent);var m=I;return evenTarget?0==r.max_iob?(console.error("SMB disabled because of maxIOB=0"),"blocked"):m/100<a.iob/(r.max_iob*i)?(console.error("iobTH: "+o(m,1)+"%, IOB% of maxIOB at "+o(a.iob/(r.max_iob*i)*100,1)+"%"),1!=i?(console.error("Full Loop modified maxIOB "+r.max_iob+" to effectively "+o(r.max_iob*i,2)+" due to profile % and/or exercise mode"),", effective maxIOB "+o(r.max_iob*i,2)):", maxIOB "+r.max_iob,s=", autoISF-SMB disabled:, iobTH exceeded",console.error("SMB disabled by Full Loop logic: IOB "+a.iob+" is more than "+m+"% of maxIOB "+r.max_iob),console.error("Full Loop capped"),"iobTH"):(console.error("SMB enabled - "+msgType+u+msgUnits+msgEven+msgTail),u<100?(console.error("iobTH: "+o(m,1)+"%, IOB% of maxIOB at "+o(a.iob/(r.max_iob*i)*100,1)+"%"),console.error("Loop at full power"),s=", autoISF-SMB enabled:, even TT","fullLoop"):(console.error("iobTH: "+o(m,1)+"%, IOB% of maxIOB at "+o(a.iob/(r.max_iob*i)*100,1)+"%"),s=", autoISF-SMB enabled:, even Target",console.error("Loop at medium power"),"enforced")):(console.error("SMB disabled - "+msgType+u+msgUnits+msgEven+msgTail),s=", autoISF-SMB disabled:, odd Target",console.error("Loop at minimum power"),"blocked")}return console.error("Full Loop disabled"),"oref"}function F(e,r,a){"bg"==a?(polyX=[50,60,80,90,100,110,150,180,200],polyY=[-.5,-.5,-.3,-.2,0,0,.5,.7,.7]):"delta"==a&&(polyX=[2,7,12,16,20],polyY=[0,0,.4,.7,.7]);var t=polyX.length-1,o=polyX[0],n=polyY[0],i=polyX[t],s=polyY[t],l=1,u=1,m=1,d=o;if(o>e)i=polyX[1],l=(u=n)+((s=polyY[1])-u)/(i-(m=o))*(e-m);else if(i<e)o=polyX[t-1],l=(u=n=polyY[t-1])+(s-u)/(i-(m=o))*(e-m);else for(var c=0;c<=t;c++){if(o=polyX[c],n=polyY[c],o==e){l=n;break}if(o>e){l=u+(n-u)/(o-(m=d))*(e-m);break}u=n,d=o}return l*="delta"==a?r.delta_ISFrange_weight:e>100?r.higher_ISFrange_weight:r.lower_ISFrange_weight}function w(e,r,a,t,n,i,s,l,u){console.error("check ratio "+o(e,2)+" against autoISF min: "+r+" and autoISF max: "+a),e<r?(b=" (lmtd.min)",c="weakest autoISF factor "+o(e,2)+" limited by autoISF_min "+r,console.error(c),e=r):e>a&&(b=" (lmtd.max)",c="strongest autoISF factor "+o(e,2)+" limited by autoISF_max "+a,console.error(c),e=a);var m=1;return s&&i.temptargetSet&&l>u?(m=e*t,n=" (exerciseMode)",console.error("autoISF adjusts sens "+t+", instead of profile.sens "+i.sens),f=n):e>=1?(m=Math.max(e,t),e>=t&&(n="")):(m=Math.min(e,t),e<=t&&(n="")),c="final ISF factor "+o(m,2)+n,console.error(c),m}e.exports=function(e,r,a,D,O,C,G,U,A,R,P,E,k,j,q){var L=0,W="",z="",H="",N="",X="",Y=0,Z=0,$=0,J=0,K=0,Q=0;const V=j.tddYtd,ee=j.tdd7d,re=j.hbt,ae=j.isEnabled,te=e.avgdelta;function oe(e,r){var a=e.getTime();return new Date(a+36e5*r)}function ne(e){var r=D.bolus_increment;.025!=r&&(r=.05);var a=e/r;return a>=1?o(Math.floor(a)*r,5):0}function ie(e){function r(e){return e<10&&(e="0"+e),e}return r(e.getHours())+":"+r(e.getMinutes())+":00"}function se(e,r){var a=new Date("1/1/1999 "+e),t=new Date("1/1/1999 "+r);return(a.getTime()-t.getTime())/36e5}function le(e,r){var a=0,t=r,o=(e-r)/36e5,n=0,i=o,s=0;do{if(o>0){var l=ie(t);k[0].rate;for(let e=0;e<k.length;e++){var u=k[e].start;if(l==u){if(e+1<k.length){o>=(s=se(k[e+1].start,k[e].start))?n=s:o<s&&(n=o)}else if(e+1==k.length){let r=k[0].start;o>=(s=24-se(k[e].start,r))?n=s:o<s&&(n=o)}a+=ne(k[e].rate*n),o-=n,t=oe(t,n)}else if(l>u)if(e+1<k.length){var m=k[e+1].start;l<m&&(o>=(s=se(m,l))?n=s:o<s&&(n=o),a+=ne(k[e].rate*n),o-=n,t=oe(t,n))}else if(e==k.length-1){o>=(s=se("23:59:59",l))?n=s:o<s&&(n=o),a+=ne(k[e].rate*n),o-=n,t=oe(t,n)}}}}while(o>0&&o<i);return a}if(P.length){let e=P.length-1;var ue=new Date(P[e].timestamp),me=new Date(P[0].timestamp);if("TempBasalDuration"==P[0]._type&&(me=new Date),(L=(me-ue)/36e5)<23.9&&L>21)K=le(ue,(de=24-L,ce=ue.getTime(),new Date(ce-36e5*de))),N="24 hours of data is required for an accurate tdd calculation. Currently only "+L.toPrecision(3)+" hours of pump history data are available. Using your pump scheduled basals to fill in the missing hours. Scheduled basals added: "+K.toPrecision(5)+" U. ";else N=""}else console.log("Pumphistory is empty!"),dynISFenabled=!1,enableDynamicCR=!1;var de,ce,pe=0,be=0;o((new Date(Oe).getTime()-C.lastBolusNormalTime)/6e4,1);for(let e=0;e<P.length;e++)if("Bolus"==P[e]._type&&(J+=P[e].amount,0==pe&&P[e].amount>=D.iTime_Start_Bolus)){pe=t(P[e].amount,D);var fe=new Date(P[e].timestamp);be=o((new Date-fe)/36e5*60)}for(let e=1;e<P.length;e++)if("TempBasal"==P[e]._type&&P[e].rate>0){Y=e,Q=P[e].rate;var ge=P[e-1]["duration (min)"]/60,he=ge,Be=new Date(P[e-1].timestamp),ve=Be;do{if(e--,0==e){ve=new Date;break}if("TempBasal"==P[e]._type||"PumpSuspend"==P[e]._type){ve=new Date(P[e].timestamp);break}}while(e>0);var _e=(ve-Be)/36e5;_e<he&&(ge=_e),$+=ne(Q*ge),e=Y}for(let e=0;e<P.length;e++)if(0,0==P[e]["duration (min)"]||"PumpResume"==P[e]._type){let r=new Date(P[e].timestamp),a=r,t=e;do{if(t>0&&(--t,"TempBasal"==P[t]._type)){a=new Date(P[t].timestamp);break}}while(t>0);(a-r)/36e5>0&&(K+=le(a,r))}for(let e=P.length-1;e>0;e--)if("TempBasalDuration"==P[e]._type){let r=P[e]["duration (min)"]/60,a=new Date(P[e].timestamp);var Me=a;let t=e;do{if(--t,t>=0&&("TempBasal"==P[t]._type||"PumpSuspend"==P[t]._type)){Me=new Date(P[t].timestamp);break}}while(t>0);if(0==e&&"TempBasalDuration"==P[0]._type&&(Me=new Date,r=P[e]["duration (min)"]/60),(Me-a)/36e5-r>0){K+=le(Me,oe(a,r))}}var Se={TDD:o(Z=J+$+K,5),bolus:o(J,5),temp_basal:o($,5),scheduled_basal:o(K,5)},xe=Z;L>21?(z=". Bolus insulin: "+J.toPrecision(5)+" U",H=". Temporary basal insulin: "+$.toPrecision(5)+" U",W=". Insulin with scheduled basal rate: "+K.toPrecision(5)+" U",X=N+(" TDD past 24h is: "+Z.toPrecision(5)+" U")+z+H+W,tddReason=", TDD, 24h: "+o(Z,1)+", ytd: "+o(V,1)+", 7dØ: "+o(ee,1),console.error(X)):tddReason=", TDD: Not enough pumpData (< 21h)";var ye={},Ie=0,Te=0,Fe=new Date;if(R&&(Fe=new Date(R)),void 0===D||void 0===D.current_basal)return ye.error="Error: could not get current basal rate",ye;var we=t(D.current_basal,D),De=we,Oe=new Date;R&&(Oe=new Date(R));var Ce,Ge=new Date(e.date),Ue=o((Oe-Ge)/60/1e3,1),Ae=e.glucose,Re=e.noise;Ce=n(e.delta,D);var Pe=Math.min(e.delta,e.short_avgdelta),Ee=Math.min(e.short_avgdelta,e.long_avgdelta),ke=Math.max(e.delta,e.short_avgdelta,e.long_avgdelta);(Ae<=10||38===Ae||Re>=3)&&(ye.reason="CGM is calibrating, in ??? state, or noise is high");if(Ue>12||Ue<-5?ye.reason="If current system time "+Oe+" is correct, then BG data is too old. The last BG data was read "+Ue+"m ago at "+Ge:Ae>60&&e.cgmFlatMinutes>89&&(e.last_cal&&e.last_cal<3?ye.reason="CGM was just calibrated":ye.reason="Error: CGM data was suspiciously flat for the past ~"+o(e.cgmFlatMinutes,1)+"m"),Ae<=10||38===Ae||Re>=3||Ue>12||Ue<-5||Ae>60&&e.cgmFlatMinutes>89||0===e.short_avgdelta&&0===e.long_avgdelta)return r.rate>De?(ye.reason+=". Replacing high temp basal of "+r.rate+" with neutral temp of "+De,ye.deliverAt=Fe,ye.temp="absolute",ye.duration=30,ye.rate=De,ye):0===r.rate&&r.duration>30?(ye.reason+=". Shortening "+r.duration+"m long zero temp to 30m. ",ye.deliverAt=Fe,ye.temp="absolute",ye.duration=30,ye.rate=0,ye):(ye.reason+=". Temp "+r.rate+" <= current basal "+o(De,2)+"U/hr; doing nothing. ",ye);var je,qe,Le,We,ze=D.max_iob;if(void 0!==D.min_bg&&(qe=D.min_bg),void 0!==D.max_bg&&(Le=D.max_bg),void 0!==D.enableSMB_high_bg_target&&(We=D.enableSMB_high_bg_target),void 0===D.min_bg||void 0===D.max_bg)return ye.error="Error: could not determine target_bg. ",ye;je=(D.min_bg+D.max_bg)/2;var He=1,Ne="",Xe=D.exercise_mode||D.high_temptarget_raises_sensitivity,Ye=100,Ze=160;D.half_basal_exercise_target&&(Ze=D.half_basal_exercise_target),ae&&(Ze=re);var $e=1;if(Xe&&D.temptargetSet&&je>Ye||D.low_temptarget_lowers_sensitivity&&D.temptargetSet&&je<Ye){var Je=Ze-Ye;He=Je*(Je+je-Ye)<=0?D.autosens_max:Je/(Je+je-Ye),$e=He=o(He=Math.min(He,D.autosens_max),2),Ne=" from TT modifier",g+=", Ratio TT: "+He,process.stderr.write("Sensitivity ratio set to "+He+" based on temp target of "+je+"; ")}else void 0!==O&&O&&D.enable_autosens&&(He=O.ratio,Ne=" from Autosens",B=", autosens:, "+o(He,2),process.stderr.write("Autosens ratio: "+He+"; "));var Ke=$e;if(He&&(De=D.current_basal*He,(De=t(De,D))!==we?process.stderr.write("Adjusting basal from "+we+" to "+De+"; "):process.stderr.write("Basal unchanged: "+De+"; ")),D.temptargetSet);else if(void 0!==O&&O&&(D.sensitivity_raises_target&&O.ratio<1||D.resistance_lowers_target&&O.ratio>1)){qe=o((qe-60)/O.ratio)+60,Le=o((Le-60)/O.ratio)+60;var Qe=o((je-60)/O.ratio)+60;je===(Qe=Math.max(80,Qe))?process.stderr.write("target_bg unchanged: "+Qe+"; "):process.stderr.write("target_bg from "+je+" to "+Qe+"; "),je=Qe}var Ve=200,er=200,rr=200;if(e.noise>=2){var ar=Math.max(1.1,D.noisyCGMTargetMultiplier);Math.min(250,D.maxRaw);Ve=o(Math.min(200,qe*ar)),er=o(Math.min(200,je*ar)),rr=o(Math.min(200,Le*ar)),process.stderr.write("Raising target_bg for noisy / raw CGM data, from "+je+" to "+er+"; "),qe=Ve,je=er,Le=rr}var tr=.5;D.smb_threshold_ratio>.5&&D.smb_threshold_ratio<=1&&(tr=D.smb_threshold_ratio);var or=qe-(1-tr)*(qe-40);console.log("SMB Threshold set to "+tr+" - no SMB's applied below "+n(or,D));var nr=o(D.sens,1),ir=D.sens;void 0!==O&&O&&((ir=o(ir=D.sens/He,1))!==nr?process.stderr.write("ISF from "+n(nr,D)+" to "+n(ir,D)):process.stderr.write("ISF unchanged: "+n(ir,D))),console.error("CR: "+D.carb_ratio),console.error("----------------------------------"),console.error(" start autoISF"),console.error("----------------------------------");var sr=!0,lr=!1,ur=r.rate,mr=D.b30_duration,dr=mr+1;if(console.error("B30 enabled: "+D.use_B30),D.use_B30&&D.use_autoisf){var cr=D.iTime_Start_Bolus,pr=D.iTime_target,br=D.b30_upperBG,fr=D.b30_upperdelta,gr=D.b30_factor,hr=!1;D.temptargetSet&&(hr=!0);var Br=be;0==Br&&(Br=1);var vr=pe;console.error("B30 last bolus above limit of "+cr+"U was "+vr+"U, "+Br+"m ago"),vr>=cr&&Br<=mr&&hr&&je==pr&&(dr=Br,lr=!0,console.error("B30 iTime is running : "+dr+"m because manual bolus ("+vr+") >= Minimum Start Bolus size ("+cr+") and EatingSoon TT set at "+n(pr,D))),console.error("B30 Activation: "+lr),console.error("B30 TTset: "+hr+", at "+je+", last Bolus of "+vr+"U, "+Br+"m ago. iTime remaining: "+(mr-dr)+"m."),lr&&(e.delta<=fr&&Ae<br&&(sr=!1),dr<=mr&&(ur=t(De*gr,D),h="AIMI B30, Temp "+ur+"U/hr for "+(mr-dr)+"m, "))}var _r=T(U,D,a,sr,Ke),Mr=!1;if(U&&"oref"!=_r?("enforced"!=_r&&"fullLoop"!=_r||(Mr=!0),console.error("loop_smb function overriden with autoISF checks, enableSMB = "+Mr)):(Mr=function(e,r,a,t,o,i){return r?!e.allowSMB_with_high_temptarget&&e.temptargetSet&&o>100?(console.error("SMB disabled due to high temptarget of "+o),!1):!0===a.bwFound&&!1===e.A52_risk_enable?(console.error("SMB disabled due to Bolus Wizard activity in the last 6 hours."),!1):!0===e.enableSMB_always?(a.bwFound?console.error("Warning: SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled due to enableSMB_always"),!0):!0===e.enableSMB_with_COB&&a.mealCOB?(a.bwCarbs?console.error("Warning: SMB enabled with Bolus Wizard carbs: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for COB of"+a.mealCOB),!0):!0===e.enableSMB_after_carbs&&a.carbs?(a.bwCarbs?console.error("Warning: SMB enabled with Bolus Wizard carbs: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for 6h after carb entry"),!0):!0===e.enableSMB_with_temptarget&&e.temptargetSet&&o<100?(a.bwFound?console.error("Warning: SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for temptarget of "+n(o,e)),console.error("SMB enabled for temptargets with "+n(o,e)),!0):!0===e.enableSMB_high_bg&&null!==i&&t>=i?(console.error("Checking BG to see if High for SMB enablement."),console.error("Current BG",t," | High BG ",i),a.bwFound?console.error("Warning: High BG SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("High BG detected. Enabling SMB."),!0):(console.error("SMB disabled (no enableSMB preferences active or no condition satisfied)"),!1):(console.error("SMB disabled (!microBolusAllowed)"),!1)}(D,U,C,Ae,je,We),console.error("loop_smb function returns enableSMB = "+Mr)),ir=function(e,r,a,t,g,h,B,I,T,D,O,C){if(!t.use_autoisf)return console.error("autoISF disabled in Preferences"),i+=", autoISF disabled",e;if(t.autoISF_off_Sport&&(t.high_temptarget_raises_sensitivity||t.exercise_mode)&&t.temptargetSet&&a>C)return console.error("autoISF disabled due to exercise"),i+=", autoISF disabled (exercise)",e;const G=g.dura_p,U=g.delta_pl,A=g.delta_pn,R=g.r_squ,P=g.bg_acceleration,E=g.a_0,k=g.a_1,j=g.a_2,q=g.dura_ISF_minutes,L=g.dura_ISF_average;t.autoISF_min;var W=t.autoISF_max,z=!1,H=e,N=a+10-g.glucose,X=g.pp_debug;if("bg_acceleration: "+o(P,3)+", PF-minutes: "+G+", PF-corr: "+o(R,4)+", PF-nextDelta: "+n(A,t)+", PF-lastDelta: "+n(U,t)+", regular Delta: "+n(g.delta,t),console.error(X),t.enable_BG_acceleration){var Y=R;if(0!=j&&Y>=.9){var Z=-k/2/j*5,$=o(E-Z*Z/25*j,1);(Z=o(Z,1))>0&&P<0?(p="predicts a Max of "+n($,t)+", in about "+Math.abs(Z)+"min",console.error("Parabolic fit "+p)):Z>0&&P>0?(p="predicts a Min of "+n($,t)+", in about "+Math.abs(Z)+"min",console.error("Parabolic fit "+p),Z<=30&&$<a&&(_=-t.bgBrake_ISF_weight,p="predicts BG below target soon, applying bgBrake ISF weight of "+-_,console.error("Parabolic fit "+p))):Z<0&&P<0?(p="saw Max of "+n($,t)+", about "+Math.abs(Z)+"min ago",console.error("Parabolic fit "+p)):Z<0&&P>0&&(p="saw Min of "+n($,t)+", about "+Math.abs(Z)+"min ago",console.error("Parabolic fit "+p))}if(Y<.9)p="acce_ISF by-passed, as correlation, "+o(Y,2)+", is too low",console.error("Parabolic fit "+p),d+=", Parabolic Fit:, "+p;else{var J=10*(Y-.9),K=1;1==_&&g.glucose<t.target_bg?P>0?(P>1&&(K=.5),_=t.bgBrake_ISF_weight):P<0&&(_=t.bgAccel_ISF_weight):1==_&&(P<0?_=t.bgBrake_ISF_weight:P>0&&(_=t.bgAccel_ISF_weight)),(v=1+P*K*_*J)<0&&(v=.1),console.error(d+"acce_ISF adaptation is "+o(v,2)),1!=v&&(z=!0,d+=", Parabolic Fit:, "+p+", acce-ISF Ratio:, "+o(v,2))}}else console.error("autoISF BG accelertion adaption disabled in Preferences");i+=s+d+", autoISF",M=1+F(100-N,t,"bg"),console.error("bg_ISF adaptation is "+o(M,2));var Q=1,V=1;if(M<1)return Q=Math.min(M,v),v>1?(c="bg-ISF adaptation lifted to "+o(Q=M*v,2)+", as BG accelerates already",console.error(c),i+=", bg-ISF Ratio: "+o(Q,2)+"(accel.)"):i+=", bg-ISF Ratio: "+o(Q,2)+"(minimal)",V=w(Q,t.autoISF_min,W,T,r,t,O,a,C),H=Math.min(720,o(t.sens/V,1)),i+=", final Ratio: "+o(V,2)+f+b+", final ISF: "+n(t.sens,t)+"→"+n(H,t),H;M>1&&(z=!0,i+=", bg-ISF Ratio: "+o(M,2));var ee=g.delta,re=new Date,ae="";B&&(re=new Date(B)),t.enable_pp_ISF_always||t.pp_ISF_hours>=(re-new Date(h.lastCarbTime))/1e3/3600?deltaType="pp":deltaType="delta",N>0?console.error(deltaType+"_ISF adaptation by-passed as average glucose < "+a+"+10"):g.short_avgdelta<0?console.error(deltaType+"_ISF adaptation by-passed as no rise or too short lived"):"pp"==deltaType?(x=1+Math.max(0,ee*t.pp_ISF_weight),t.enable_pp_ISF_always||(ae=", last Meal "+o((re-h.lastCarbTime)/1e3/3600,1)+" hrs ago is within Range of "+t.pp_ISF_hours+" hrs."),console.error("pp_ISF adaptation is "+o(x,2)+ae),u=", pp-ISF Ratio: "+o(x,2),1!=x&&(z=!0)):(S=F(ee,t,"delta"),N>-20&&(S*=.5),S=1+S,console.error("delta_ISF adaptation is "+o(S,2)),m=", Δ-ISF Ratio: "+o(S,2),1!=S&&(z=!0));var te=t.dura_ISF_weight;h.mealCOB>0&&!t.enableautoisf_with_COB?console.error("dura_ISF by-passed; preferences disabled mealCOB of "+o(h.mealCOB,1)):q<10?console.error("dura_ISF by-passed; BG is only "+q+"m at level "+L):L<=a?console.error("dura_ISF by-passed; avg. glucose "+L+" below target "+n(a,t)):(y+=q/60*(te/a)*(L-a),z=!0,l=", Duration: "+q+", Avg: "+n(L,t)+", dura-ISF Ratio: "+o(y,2),console.error("dura_ISF adaptation is "+o(y,2)+" because ISF "+e+" did not do it for "+o(q,1)+"m"));return z?(Q=Math.max(y,M,S,v,x),console.error("autoISF adaption ratios:"),console.error("  acce "+o(v,2)),console.error("  bg "+o(M,2)),console.error("  dura "+o(y,2)),console.error("  pp "+o(x,2)),console.error("  delta "+o(S,2)),v<1&&(c="strongest autoISF factor "+o(Q,2)+" weakened to "+o(Q*v,2)+" as bg decelerates already",console.error(c),Q*=v),V=w(Q,t.autoISF_min,W,T,r,t,O,a,C),H=o(t.sens/V,1),i+=u+m+l+", final Ratio: "+o(V,2)+f+b+", final ISF: "+n(t.sens,t)+"→"+n(H,t),H):(i+=", not modified",console.error("autoISF does not modify"),H)}(ir,Ne,je,D,e,C,R,0,He,0,Xe,Ye),console.error("----------------------------------"),console.error(" end autoISF"),console.error("----------------------------------"),void 0===a)return ye.error="Error: iob_data undefined. ",ye;var Sr,xr=a;if(a.length,a.length>1&&(a=xr[0]),void 0===a.activity||void 0===a.iob)return ye.error="Error: iob_data missing some property. ",ye;var yr=((Sr=void 0!==a.lastTemp?o((new Date(Oe).getTime()-a.lastTemp.date)/6e4):0)+r.duration)%30;if(console.error("currenttemp:"+r.rate+" lastTempAge:"+Sr+"m, tempModulus:"+yr+"m"),ye.temp="absolute",ye.deliverAt=Fe,U&&r&&a.lastTemp&&r.rate!==a.lastTemp.rate&&Sr>10&&r.duration)return ye.reason="Warning: currenttemp rate "+r.rate+" != lastTemp rate "+a.lastTemp.rate+" from pumphistory; canceling temp",G.setTempBasal(0,0,D,ye,r);if(r&&a.lastTemp&&r.duration>0){var Ir=Sr-a.lastTemp.duration;if(Ir>5&&Sr>10)return ye.reason="Warning: currenttemp running but lastTemp from pumphistory ended "+Ir+"m ago; canceling temp",G.setTempBasal(0,0,D,ye,r)}var Tr=o(-a.activity*ir*5,2),Fr=o(6*(Pe-Tr));Fr<0&&(Fr=o(6*(Ee-Tr)))<0&&(Fr=o(6*(e.long_avgdelta-Tr)));var wr=Ae,Dr=(wr=a.iob>0?o(Ae-a.iob*ir):o(Ae-a.iob*Math.min(ir,D.sens)))+Fr;if(void 0===Dr||isNaN(Dr))return ye.error="Error: could not calculate eventualBG. Sensitivity: "+ir+" Deviation: "+Fr,ye;var Or=function(e,r,a){return o(a+(e-r)/24,1)}(je,Dr,Tr);ye={temp:"absolute",bg:n(Ae,D),tick:Ce,eventualBG:Dr,insulinReq:0,reservoir:A,deliverAt:Fe,sensitivityRatio:He,TDD:xe,insulin:Se,avgDelta:n(te,D)};var Cr=[],Gr=[],Ur=[],Ar=[];Cr.push(Ae),Gr.push(Ae),Ar.push(Ae),Ur.push(Ae);var Rr=D.enableUAM,Pr=0,Er=0;Pr=o(Pe-Tr,1);var kr=o(Pe-Tr,1);csf=ir/D.carb_ratio,console.error("profile.sens:"+n(D.sens,D)+", sens:"+n(ir,D)+", CSF:"+o(csf,1));var jr=o(30*csf*5/60,1);Pr>jr&&(console.error("Limiting carb impact from "+Pr+" to "+jr+"mg/dL/5m (30g/h)"),Pr=jr);var qr=3;He&&(qr/=He);var Lr=qr;if(C.carbs){qr=Math.max(qr,C.mealCOB/20);var Wr=o((new Date(Oe).getTime()-C.lastCarbTime)/6e4),zr=(C.carbs-C.mealCOB)/C.carbs;Lr=o(Lr=qr+1.5*Wr/60,1),console.error("Last carbs "+Wr+" minutes ago; remainingCATime:"+Lr+"hours; "+o(100*zr)+"% carbs absorbed")}var Hr=Math.max(0,Pr/5*60*Lr/2)/csf,Nr=90,Xr=1;D.remainingCarbsCap&&(Nr=Math.min(90,D.remainingCarbsCap)),D.remainingCarbsFraction&&(Xr=Math.min(1,D.remainingCarbsFraction));var Yr=1-Xr,Zr=Math.max(0,C.mealCOB-Hr-C.carbs*Yr),$r=(Zr=Math.min(Nr,Zr))*csf*5/60/(Lr/2),Jr=o(C.slopeFromMaxDeviation,2),Kr=o(C.slopeFromMinDeviation,2),Qr=Math.min(Jr,-Kr/3),Vr=0;0===Pr?Er=0:!0===D.floating_carbs?(Er=Math.min(60*Lr/5/2,Math.max(0,C.carbs*csf/Pr)),Vr=Math.min(60*Lr/5/2,Math.max(0,C.mealCOB*csf/Pr)),C.carbs>0&&(i+=", Floating Carbs:, CID: "+o(Er,1)+", MealCarbs: "+o(C.carbs,1)+", Not Floating:, CID: "+o(Vr,1)+", MealCOB: "+o(C.mealCOB,1),console.error("Floating Carbs CID: "+o(Er,1)+" / MealCarbs: "+o(C.carbs,1)+" vs. Not Floating:"+o(Vr,1)+" / MealCOB:"+o(C.mealCOB,1)))):Er=Math.min(60*Lr/5/2,Math.max(0,C.mealCOB*csf/Pr)),console.error("Carb Impact:"+Pr+"mg/dL per 5m; CI Duration:"+o(5*Er/60*2,1)+"hours; remaining CI ("+o(Lr/2,2)+"h peak):",o($r,1)+"mg/dL per 5m");var ea,ra,aa,ta,oa,na=999,ia=999,sa=999,la=Ae,ua=999,ma=999,da=999,ca=999,pa=Dr,ba=Ae,fa=Ae,ga=0,ha=[],Ba=[];try{xr.forEach((function(e){var r=o(-e.activity*ir*5,2),a=o(-e.iobWithZeroTemp.activity*ir*5,2),t=Pr*(1-Math.min(1,Gr.length/12));pa=Gr[Gr.length-1]+r+t;var n=Ar[Ar.length-1]+a,i=Math.max(0,Math.max(0,Pr)*(1-Cr.length/Math.max(2*Er,1))),s=Math.min(Cr.length,12*Lr-Cr.length),l=Math.max(0,s/(Lr/2*12)*$r);i+l,ha.push(o(l,0)),Ba.push(o(i,0)),COBpredBG=Cr[Cr.length-1]+r+Math.min(0,t)+i+l;var u=Math.max(0,kr+Ur.length*Qr),m=Math.max(0,kr*(1-Ur.length/Math.max(36,1))),d=Math.min(u,m);d>0&&(ga=o(5*(Ur.length+1)/60,1)),UAMpredBG=Ur[Ur.length-1]+r+Math.min(0,t)+d,Gr.length<48&&Gr.push(pa),Cr.length<48&&Cr.push(COBpredBG),Ur.length<48&&Ur.push(UAMpredBG),Ar.length<48&&Ar.push(n),COBpredBG<ua&&(ua=o(COBpredBG)),UAMpredBG<ma&&(ma=o(UAMpredBG)),pa<da&&(da=o(pa)),n<ca&&(ca=o(n));Gr.length>18&&pa<na&&(na=o(pa)),pa>ba&&(ba=pa),(Er||$r>0)&&Cr.length>18&&COBpredBG<ia&&(ia=o(COBpredBG)),(Er||$r>0)&&COBpredBG>ba&&(fa=COBpredBG),Rr&&Ur.length>12&&UAMpredBG<sa&&(sa=o(UAMpredBG)),Rr&&UAMpredBG>ba&&UAMpredBG}))}catch(e){console.error("Problem with iobArray.  Optional feature Advanced Meal Assist disabled")}ye.predBGs={},Gr.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))}));for(var va=Gr.length-1;va>12&&Gr[va-1]===Gr[va];va--)Gr.pop();for(ye.predBGs.IOB=Gr,aa=o(Gr[Gr.length-1]),Ar.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),va=Ar.length-1;va>6&&!(Ar[va-1]>=Ar[va]||Ar[va]<=je);va--)Ar.pop();if(ye.predBGs.ZT=Ar,o(Ar[Ar.length-1]),C.mealCOB>0&&(Pr>0||$r>0)){for(Cr.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),va=Cr.length-1;va>12&&Cr[va-1]===Cr[va];va--)Cr.pop();ye.predBGs.COB=Cr,ta=o(Cr[Cr.length-1]),Dr=Math.max(Dr,o(Cr[Cr.length-1]))}if(Pr>0||$r>0){if(Rr){for(Ur.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),va=Ur.length-1;va>12&&Ur[va-1]===Ur[va];va--)Ur.pop();ye.predBGs.UAM=Ur,oa=o(Ur[Ur.length-1]),Ur[Ur.length-1]&&(Dr=Math.max(Dr,o(Ur[Ur.length-1])))}ye.eventualBG=Dr}console.error("UAM Impact:"+kr+"mg/dL per 5m; UAM Duration:"+ga+"hours"),na=Math.max(39,na),ia=Math.max(39,ia),sa=Math.max(39,sa),ea=o(na);var _a=C.mealCOB/C.carbs;ra=o(sa<999&&ia<999?(1-_a)*UAMpredBG+_a*COBpredBG:ia<999?(pa+COBpredBG)/2:sa<999?(pa+UAMpredBG)/2:pa),ca>ra&&(ra=ca),la=o(la=Er||$r>0?Rr?_a*ua+(1-_a)*ma:ua:Rr?ma:da);var Ma=sa;if(ca<or)Ma=(sa+ca)/2;else if(ca<je){var Sa=(ca-or)/(je-or);Ma=(sa+(sa*Sa+ca*(1-Sa)))/2}else ca>sa&&(Ma=(sa+ca)/2);if(Ma=o(Ma),C.carbs)if(!Rr&&ia<999)ea=o(Math.max(na,ia));else if(ia<999){var xa=_a*ia+(1-_a)*Ma;ea=o(Math.max(na,ia,xa))}else ea=Rr?Ma:la;else Rr&&(ea=o(Math.max(na,Ma)));ea=Math.min(ea,ra),process.stderr.write("minPredBG: "+n(ea,D)+" minIOBPredBG: "+n(na,D)+" minZTGuardBG: "+n(ca,D)),ia<999&&process.stderr.write(" minCOBPredBG: "+n(ia,D)),sa<999&&process.stderr.write(" minUAMPredBG: "+n(sa,D)),console.error(" avgPredBG:"+n(ra,D)+" COB/Carbs:"+C.mealCOB+"/"+C.carbs),fa>Ae&&(ea=Math.min(ea,fa)),ye.COB=C.mealCOB,ye.IOB=a.iob,ye.bolusIOB=a.bolusiob,ye.basalIOB=a.basaliob,ye.iobActivity=a.activity,ye.BGI=n(Tr,D),ye.deviation=n(Fr,D),ye.dura_ISFratio=o(y,2),ye.bg_ISFratio=o(M,2),ye.delta_ISFratio=o(S,2),ye.pp_ISFratio=o(x,2),ye.acce_ISFratio=o(v,2),ye.auto_ISFratio=o(D.sens/ir,2),ye.ISF=n(ir,D),ye.CR=o(D.carb_ratio,2),ye.TDD=o(xe,1),ye.TDDytd=o(V,1),ye.TDD7d=o(ee,1),ye.target_bg=n(je,D),ye.minDelta=Pe,ye.expectedDelta=Or,ye.minGuardBG=la,ye.minPredBG=ea;var ya=function(e,r,a,t){if(!e.use_autoisf)return console.error("autoISF disabled, don't adjust SMB Delivery Ratio"),.5;var n=e.smb_delivery_ratio_bg_range;n<10&&(n/=.0555);var i=e.smb_delivery_ratio,s=Math.min(e.smb_delivery_ratio_min,e.smb_delivery_ratio_max),l=Math.max(e.smb_delivery_ratio_min,e.smb_delivery_ratio_max),u=a+n,m=i;return n>0&&(m=s+(l-s)*(r-a)/n,m=Math.max(s,Math.min(l,m))),"fullLoop"==t?(console.error("SMB delivery ratio set to "+o(Math.max(i,m),2)+" as max of fixed and interpolated values"),Math.max(i,m)):0==n?(console.error("SMB delivery ratio set to fixed value "+o(i,2)),i):r<=a?(console.error("SMB delivery ratio limited by minimum value "+o(s,2)),s):r>=u?(console.error("SMB delivery ratio limited by maximum value "+o(l,2)),l):(console.error("SMB delivery ratio set to interpolated value "+o(m,2)),m)}(D,Ae,je,_r);ye.SMBratio=o(ya,2);var Ia="SMB Del.Ratio:, "+o(ya,2);let Ta="";""!==q&&"Nothing changed"!==q&&(Ta="Middleware:, "+q+", "),ye.reason=Ta+h+Ia+B+g+i+", Standard, COB: "+ye.COB+", Dev: "+ye.deviation+", BGI: "+ye.BGI+", ISF: "+ye.ISF+", CR: "+ye.CR+", Target: "+ye.target_bg+", minPredBG "+n(ea,D)+", minGuardBG "+n(la,D)+", IOBpredBG "+n(aa,D),ta>0&&(ye.reason+=", COBpredBG "+n(ta,D)),oa>0&&(ye.reason+=", UAMpredBG "+n(oa,D)),ye.reason+=tddReason,ye.reason+="; ";var Fa=wr;Fa<40&&(Fa=Math.min(la,Fa));var wa=or-Fa,Da=240,Oa=240;if(C.mealCOB>0&&(Pr>0||$r>0)){for(va=0;va<Cr.length;va++)if(Cr[va]<qe){Da=5*va;break}for(va=0;va<Cr.length;va++)if(Cr[va]<or){Oa=5*va;break}}else{for(va=0;va<Gr.length;va++)if(Gr[va]<qe){Da=5*va;break}for(va=0;va<Gr.length;va++)if(Gr[va]<or){Oa=5*va;break}}Mr&&la<or&&(console.error("minGuardBG "+n(la,D)+" projected below "+n(or,D)+" - disabling SMB"),Te=1,Ie=o((Dr-je)/ir,2),Mr=!1);var Ca=.2;"fullLoop"==_r&&(Ca=.3),ke>Ca*Ae&&(console.error("maxDelta "+n(ke,D)+" > "+100*Ca+"% of BG "+n(Ae,D)+" - disabling SMB"),ye.reason+="maxDelta "+n(ke,D)+" > "+100*Ca+"% of BG "+n(Ae,D)+" - SMB disabled!, ",Mr=!1),console.error("BG projected to remain above "+n(qe,D)+" for "+Da+"minutes"),(Oa<240||Da<60)&&console.error("BG projected to remain above "+n(or,D)+" for "+Oa+"minutes");var Ga=Oa,Ua=D.current_basal*ir*Ga/60,Aa=Math.max(0,C.mealCOB-.25*C.carbs),Ra=(wa-Ua)/csf-Aa;if(Ua=o(Ua),Ra=o(Ra),console.error("naive_eventualBG: "+n(wr,D)+", bgUndershoot: "+n(wa,D)+", zeroTempDuration: "+Ga+", zeroTempEffect: "+Ua+", carbsReq: "+Ra),"Could not parse clock data"==C.reason?console.error("carbsReq unknown: Could not parse clock data"):Ra>=D.carbsReqThreshold&&Oa<=45&&(ye.carbsReq=Ra,ye.reason+=Ra+" add'l carbs req w/in "+Oa+"m; "),lr&&dr<=mr)return ye.reason+="setting AIMI B30 Temp "+t(ur,D)+"U/hr for "+(mr-dr)+"m ",ye.temp="absolute",ye.deliverAt=Fe,ye.duration=Math.min(30,mr-dr),console.error("Forcing AIMI temp "+ur+"U/hr"),G.setTempBasal(ur,30,D,ye,r);var Pa=0;if(Ae<or&&a.iob<20*-D.current_basal/60&&Pe>0&&Pe>Or)ye.reason+="IOB "+a.iob+" < "+o(20*-D.current_basal/60,2),ye.reason+=" and minDelta "+n(Pe,D)+" > expectedDelta "+n(Or,D)+"; ";else if(Ae<or||la<or)return ye.reason+="minGuardBG "+n(la,D)+"<"+n(or,D),la<or&&(Te=2),Ie=o((Dr-je)/ir,2),Pa=o(60*((wa=je-la)/ir)/D.current_basal),Pa=30*o(Pa/30),Pa=Math.min(120,Math.max(30,Pa)),G.setTempBasal(0,Pa,D,ye,r);if(D.skip_neutral_temps&&ye.deliverAt.getMinutes()>=55){if(!Mr)return ye.reason+="; Canceling temp at "+(60-ye.deliverAt.getMinutes())+"min before turn of the hour to avoid beeping of MDT. SMB disabled anyways.",G.setTempBasal(0,0,D,ye,r);console.error(60-ye.deliverAt.getMinutes()+"min before turn of the hour, but SMB's are enabled - no skipping neutral temps")}var Ea=0,ka=De;if(Dr<qe){if(ye.reason+="Eventual BG "+n(Dr,D)+" < "+n(qe,D),Pe>Or&&Pe>0&&!Ra)return wr<40?(ye.reason+=", naive_eventualBG < 40. ",G.setTempBasal(0,30,D,ye,r)):(e.delta>Pe?ye.reason+=", but Delta "+n(Ce,D)+" > expectedDelta "+n(Or,D):ye.reason+=", but Min. Delta "+Pe.toFixed(2)+" > Exp. Delta "+n(Or,D),r.duration>15&&t(De,D)===t(r.rate,D)?(ye.reason+=", temp "+r.rate+" ~ req "+o(De,2)+"U/hr. ",ye):(ye.reason+="; setting current basal of "+o(De,2)+" as temp. ",G.setTempBasal(De,30,D,ye,r)));Ea=o(Ea=2*Math.min(0,(Dr-je)/ir),2);var ja=Math.min(0,(wr-je)/ir);if(ja=o(ja,2),Pe<0&&Pe>Or)Ea=o(Ea*(Pe/Or),2);if(ka=t(ka=De+2*Ea,D),r.duration*(r.rate-De)/60<Math.min(Ea,ja)-.3*De)return ye.reason+=", "+r.duration+"m@"+r.rate.toFixed(2)+" is a lot less than needed. ",G.setTempBasal(ka,30,D,ye,r);if(void 0!==r.rate&&r.duration>5&&ka>=.8*r.rate)return ye.reason+=", temp "+r.rate+" ~< req "+o(ka,2)+"U/hr. ",ye;if(ka<=0){if((Pa=o(60*((wa=je-wr)/ir)/D.current_basal))<0?Pa=0:(Pa=30*o(Pa/30),Pa=Math.min(120,Math.max(0,Pa))),Pa>0)return ye.reason+=", setting "+Pa+"m zero temp. ",G.setTempBasal(ka,Pa,D,ye,r)}else ye.reason+=", setting "+o(ka,2)+"U/hr. ";return G.setTempBasal(ka,30,D,ye,r)}if(Pe<Or&&(ye.minDelta=Pe,ye.expectedDelta=Or,(Or-Pe>=2||Or+-1*Pe>=2)&&(Te=Pe>=0&&Or>0?3:Pe<0&&Or<=0||Pe<0&&Or>=0?4:5),Ie=o((Dr-je)/ir,2),!U||!Mr))return e.delta<Pe?ye.reason+="Eventual BG "+n(Dr,D)+" > "+n(qe,D)+" but Delta "+n(Ce,D)+" < Exp. Delta "+n(Or,D):ye.reason+="Eventual BG "+n(Dr,D)+" > "+n(qe,D)+" but Min. Delta "+Pe.toFixed(2)+" < Exp. Delta "+n(Or,D),r.duration>15&&t(De,D)===t(r.rate,D)?(ye.reason+=", temp "+r.rate+" ~ req "+De+"U/hr. ",ye):(ye.reason+="; setting current basal of "+De+" as temp. ",G.setTempBasal(De,30,D,ye,r));if(Math.min(Dr,ea)<Le&&(ea<qe&&Dr>qe&&(Te=6,Ie=o((Dr-je)/ir,2)),!U||!Mr))return ye.reason+=n(Dr,D)+"-"+n(ea,D)+" in range: no temp required",r.duration>15&&t(De,D)===t(r.rate,D)?(ye.reason+=", temp "+r.rate+" ~ req "+De+"U/hr. ",ye):(ye.reason+="; setting current basal of "+De+" as temp. ",G.setTempBasal(De,30,D,ye,r));if(Dr>=Le&&(ye.reason+="Eventual BG "+n(Dr,D)+" >= "+n(Le,D)+", "),a.iob>ze)return ye.reason+="IOB "+o(a.iob,2)+" > maxIOB "+ze,r.duration>15&&t(De,D)===t(r.rate,D)?(ye.reason+=", temp "+r.rate+" ~ req "+De+"U/hr. ",ye):(ye.reason+="; setting current basal of "+De+" as temp. ",G.setTempBasal(De,30,D,ye,r));Ea=o((Math.min(ea,Dr)-je)/ir,2),Ie=o((Dr-je)/ir,2),Ea>ze-a.iob?(ye.reason+="maxIOB "+ze+", ",console.error("InsReq "+o(Ea,2)+" capped at "+o(ze-a.iob,2)+" to not exceed maxIOB"),Ea=ze-a.iob):console.error("SMB not limited by maxIOB (insulinReq: "+Ea+" U)"),Ie>ze-a.iob?console.error("Ev. Bolus limited by maxIOB to "+o(ze-a.iob,2)+" (insulinForManualBolus: "+Ie+" U)"):console.error("Ev. Bolus would not be limited by maxIOB (insulinForManualBolus: "+Ie+" U)."),ka=t(ka=De+2*Ea,D),Ea=o(Ea,3),ye.insulinReq=Ea,ye.insulinForManualBolus=o(Ie,2),ye.manualBolusErrorString=Te,ye.minDelta=Pe,ye.expectedDelta=Or,ye.minGuardBG=la,ye.minPredBG=ea,ye.threshold=n(or,D),ye.reason="Ins.Req:, "+o(Ea,2)+", "+ye.reason;var qa=o((new Date(Oe).getTime()-a.lastBolusTime)/6e4,1);if(U&&Mr&&Ae>or){var La=o(C.mealCOB/D.carb_ratio,3);if(D.use_autoisf)Wa=D.smb_max_range_extension;else{console.error("autoISF disabled, SMB range extension disabled");var Wa=1}Wa>1&&console.error("SMB max range extended from default by factor "+Wa);var za=0;void 0===D.maxSMBBasalMinutes?(za=o(Wa*D.current_basal*30/60,1),console.error("profile.maxSMBBasalMinutes undefined: defaulting to 30m")):a.iob>La&&a.iob>0?(console.error("IOB "+a.iob+" > COB "+C.mealCOB+"; mealInsulinReq = "+La),D.maxUAMSMBBasalMinutes?(console.error("profile.maxUAMSMBBasalMinutes:",D.maxUAMSMBBasalMinutes,"profile.current_basal:",D.current_basal),za=o(Wa*D.current_basal*D.maxUAMSMBBasalMinutes/60,1)):(console.error("profile.maxUAMSMBBasalMinutes undefined: defaulting to 30m"),za=o(30*D.current_basal/60,1))):(console.error("profile.maxSMBBasalMinutes:",D.maxSMBBasalMinutes,"profile.current_basal:",D.current_basal),za=o(Wa*D.current_basal*D.maxSMBBasalMinutes/60,1));var Ha=D.bolus_increment,Na=1/Ha;D.use_autoisf||(console.error("autoISF disabled, don't adjust SMB Delivery Ratio"),ya=.5),ya>.5&&console.error("SMB Delivery Ratio increased from default 0.5 to "+o(ya,2));var Xa=Math.min(Ea*ya,za),Ya="",Za=I/100*130/100*D.max_iob*Ke;Xa>Za-a.iob&&("fullLoop"==_r||"enforced"==_r)&&(Xa=Za-a.iob,Ya=", capped by autoISF iobTH",console.error("autoISF capped SMB at "+o(Xa,2)+" to not exceed 130% of effective iobTH "+o(Za/130*100,2)+"U")),Xa=Math.floor(Xa*Na)/Na,Pa=o(60*((je-(wr+na)/2)/ir)/D.current_basal),Ea>0&&Xa<Ha&&(Pa=0);var $a=0;Pa<=0?Pa=0:Pa>=30?(Pa=30*o(Pa/30),Pa=Math.min(60,Math.max(0,Pa))):($a=o(De*Pa/30,2),Pa=30),ye.reason+=" insulinReq "+Ea,Xa>=za&&(ye.reason+="; maxBolus "+za),Pa>0&&(ye.reason+="; setting "+Pa+"m low temp of "+$a+"U/h"),ye.reason+=". ";var Ja=3;D.SMBInterval&&(Ja=Math.min(10,Math.max(1,D.SMBInterval)));var Ka=o(Ja-qa,0),Qa=o(60*(Ja-qa),0)%60;if(console.error("naive_eventualBG "+n(wr,D)+", "+Pa+"m "+$a+"U/h temp needed; last bolus "+qa+"m ago; maxBolus: "+za),qa>Ja?Xa>0&&(ye.units=Xa,ye.reason+="Microbolusing "+Xa+"U"+Ya+". "):ye.reason+="Waiting "+Ka+"m "+Qa+"s to microbolus again. ",Pa>0)return G.setTempBasal($a,Pa,D,ye,r)}var Va=G.getMaxSafeBasal(D);return ka>Va&&(ye.reason+="adj. req. rate: "+o(ka,2)+" to maxSafeBasal: "+o(Va,2)+", ",ka=t(Va,D)),r.duration*(r.rate-De)/60>=2*Ea?(ye.reason+=r.duration+"m@"+r.rate.toFixed(2)+" > 2 * insulinReq. Setting temp basal of "+ka+"U/hr. ",G.setTempBasal(ka,30,D,ye,r)):void 0===r.duration||0===r.duration?(ye.reason+="no temp, setting "+ka+"U/hr. ",G.setTempBasal(ka,30,D,ye,r)):r.duration>5&&t(ka,D)<=t(r.rate,D)?(ye.reason+="temp "+r.rate+" >~ req "+ka+"U/hr. ",ye):(ye.reason+="temp "+r.rate+"<"+ka+"U/hr. ",G.setTempBasal(ka,30,D,ye,r))}},6880:(e,r,a)=>{var t=a(6654);e.exports=function(e,r){var a=20;void 0!==r&&"string"==typeof r.model&&(t(r.model,"54")||t(r.model,"23"))&&(a=40);return e<1?Math.round(e*a)/a:e<10?Math.round(20*e)/20:Math.round(10*e)/10}},2705:(e,r,a)=>{var t=a(5639).Symbol;e.exports=t},9932:e=>{e.exports=function(e,r){for(var a=-1,t=null==e?0:e.length,o=Array(t);++a<t;)o[a]=r(e[a],a,e);return o}},9750:e=>{e.exports=function(e,r,a){return e==e&&(void 0!==a&&(e=e<=a?e:a),void 0!==r&&(e=e>=r?e:r)),e}},4239:(e,r,a)=>{var t=a(2705),o=a(9607),n=a(2333),i=t?t.toStringTag:void 0;e.exports=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":i&&i in Object(e)?o(e):n(e)}},531:(e,r,a)=>{var t=a(2705),o=a(9932),n=a(1469),i=a(3448),s=t?t.prototype:void 0,l=s?s.toString:void 0;e.exports=function e(r){if("string"==typeof r)return r;if(n(r))return o(r,e)+"";if(i(r))return l?l.call(r):"";var a=r+"";return"0"==a&&1/r==-Infinity?"-0":a}},7561:(e,r,a)=>{var t=a(7990),o=/^\s+/;e.exports=function(e){return e?e.slice(0,t(e)+1).replace(o,""):e}},1957:(e,r,a)=>{var t="object"==typeof a.g&&a.g&&a.g.Object===Object&&a.g;e.exports=t},9607:(e,r,a)=>{var t=a(2705),o=Object.prototype,n=o.hasOwnProperty,i=o.toString,s=t?t.toStringTag:void 0;e.exports=function(e){var r=n.call(e,s),a=e[s];try{e[s]=void 0;var t=!0}catch(e){}var o=i.call(e);return t&&(r?e[s]=a:delete e[s]),o}},2333:e=>{var r=Object.prototype.toString;e.exports=function(e){return r.call(e)}},5639:(e,r,a)=>{var t=a(1957),o="object"==typeof self&&self&&self.Object===Object&&self,n=t||o||Function("return this")();e.exports=n},7990:e=>{var r=/\s/;e.exports=function(e){for(var a=e.length;a--&&r.test(e.charAt(a)););return a}},6654:(e,r,a)=>{var t=a(9750),o=a(531),n=a(554),i=a(9833);e.exports=function(e,r,a){e=i(e),r=o(r);var s=e.length,l=a=void 0===a?s:t(n(a),0,s);return(a-=r.length)>=0&&e.slice(a,l)==r}},1469:e=>{var r=Array.isArray;e.exports=r},3218:e=>{e.exports=function(e){var r=typeof e;return null!=e&&("object"==r||"function"==r)}},7005:e=>{e.exports=function(e){return null!=e&&"object"==typeof e}},3448:(e,r,a)=>{var t=a(4239),o=a(7005);e.exports=function(e){return"symbol"==typeof e||o(e)&&"[object Symbol]"==t(e)}},8601:(e,r,a)=>{var t=a(4841),o=1/0;e.exports=function(e){return e?(e=t(e))===o||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}},554:(e,r,a)=>{var t=a(8601);e.exports=function(e){var r=t(e),a=r%1;return r==r?a?r-a:r:0}},4841:(e,r,a)=>{var t=a(7561),o=a(3218),n=a(3448),i=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,l=/^0o[0-7]+$/i,u=parseInt;e.exports=function(e){if("number"==typeof e)return e;if(n(e))return NaN;if(o(e)){var r="function"==typeof e.valueOf?e.valueOf():e;e=o(r)?r+"":r}if("string"!=typeof e)return 0===e?e:+e;e=t(e);var a=s.test(e);return a||l.test(e)?u(e.slice(2),a?2:8):i.test(e)?NaN:+e}},9833:(e,r,a)=>{var t=a(531);e.exports=function(e){return null==e?"":t(e)}}},r={};function a(t){var o=r[t];if(void 0!==o)return o.exports;var n=r[t]={exports:{}};return e[t](n,n.exports,a),n.exports}a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}();var t=a(5546);freeaps_determineBasal=t})();