var freeaps_determineBasal;(()=>{var e={5546:(e,r,a)=>{var t=a(6880);function o(e,r){r||(r=0);var a=Math.pow(10,r);return Math.round(e*a)/a}function n(e,r){return"mmol/L"===r.out_units?o(.0555*e,1):Math.round(e)}var i="",s="",l="",u="",m="",d="",c="",p="",b="",f="",g="",h="",B="",v=1,_=1,M=1,S=1,y=1,x=1;function I(e,r,a){"bg"==a?(polyX=[50,60,80,90,100,110,150,180,200],polyY=[-.5,-.5,-.3,-.2,0,0,.5,.7,.7]):"delta"==a&&(polyX=[2,7,12,16,20],polyY=[0,0,.4,.7,.7]);var t=polyX.length-1,o=polyX[0],n=polyY[0],i=polyX[t],s=polyY[t],l=1,u=1,m=1,d=o;if(o>e)i=polyX[1],l=(u=n)+((s=polyY[1])-u)/(i-(m=o))*(e-m);else if(i<e)o=polyX[t-1],l=(u=n=polyY[t-1])+(s-u)/(i-(m=o))*(e-m);else for(var c=0;c<=t;c++){if(o=polyX[c],n=polyY[c],o==e){l=n;break}if(o>e){l=u+(n-u)/(o-(m=d))*(e-m);break}u=n,d=o}return l*="delta"==a?r.delta_ISFrange_weight:e>100?r.higher_ISFrange_weight:r.lower_ISFrange_weight}function F(e,r,a,t,n,i,s,l,u){console.error("check ratio "+o(e,2)+" against autoISF min: "+r+" and autoISF max: "+a),e<r?(b=" (lmtd.min)",c="weakest autoISF factor "+o(e,2)+" limited by autoISF_min "+r,console.error(c),e=r):e>a&&(b=" (lmtd.max)",c="strongest autoISF factor "+o(e,2)+" limited by autoISF_max "+a,console.error(c),e=a);var m=1;return s&&i.temptargetSet&&l>u?(m=e*t,n=" (exerciseMode)",console.error("autoISF adjusts sens "+t+", instead of profile.sens "+i.sens),f=n):e>=1?(m=Math.max(e,t),e>=t&&(n="")):(m=Math.min(e,t),e<=t&&(n="")),c="final ISF factor "+o(m,2)+n,console.error(c),m}e.exports=function(e,r,a,T,w,D,G,C,O,U,R,A,P,E){var k=0,j="",q="",L="",W="",z="",N=0,H=0,X=0,Y=0,Z=0,$=0;const J=E.tddYtd,K=E.tdd7d,Q=E.hbt,V=E.isEnabled;function ee(e,r){var a=e.getTime();return new Date(a+36e5*r)}function re(e){var r=T.bolus_increment;.025!=r&&(r=.05);var a=e/r;return a>=1?o(Math.floor(a)*r,5):0}function ae(e){function r(e){return e<10&&(e="0"+e),e}return r(e.getHours())+":"+r(e.getMinutes())+":00"}function te(e,r){var a=new Date("1/1/1999 "+e),t=new Date("1/1/1999 "+r);return(a.getTime()-t.getTime())/36e5}function oe(e,r){var a=0,t=r,o=(e-r)/36e5,n=0,i=o,s=0;do{if(o>0){var l=ae(t);P[0].rate;for(let e=0;e<P.length;e++){var u=P[e].start;if(l==u){if(e+1<P.length){o>=(s=te(P[e+1].start,P[e].start))?n=s:o<s&&(n=o)}else if(e+1==P.length){let r=P[0].start;o>=(s=24-te(P[e].start,r))?n=s:o<s&&(n=o)}a+=re(P[e].rate*n),o-=n,t=ee(t,n)}else if(l>u)if(e+1<P.length){var m=P[e+1].start;l<m&&(o>=(s=te(m,l))?n=s:o<s&&(n=o),a+=re(P[e].rate*n),o-=n,t=ee(t,n))}else if(e==P.length-1){o>=(s=te("23:59:59",l))?n=s:o<s&&(n=o),a+=re(P[e].rate*n),o-=n,t=ee(t,n)}}}}while(o>0&&o<i);return a}if(R.length){let e=R.length-1;var ne=new Date(R[e].timestamp),ie=new Date(R[0].timestamp);if("TempBasalDuration"==R[0]._type&&(ie=new Date),(k=(ie-ne)/36e5)<23.9&&k>21)Z=oe(ne,(se=24-k,le=ne.getTime(),new Date(le-36e5*se))),W="24 hours of data is required for an accurate tdd calculation. Currently only "+k.toPrecision(3)+" hours of pump history data are available. Using your pump scheduled basals to fill in the missing hours. Scheduled basals added: "+Z.toPrecision(5)+" U. ";else W=""}else console.log("Pumphistory is empty!"),dynISFenabled=!1,enableDynamicCR=!1;var se,le,ue=0,me=0;o((new Date(Fe).getTime()-D.lastBolusNormalTime)/6e4,1);for(let e=0;e<R.length;e++)if("Bolus"==R[e]._type&&(Y+=R[e].amount,0==ue&&R[e].amount>=T.iTime_Start_Bolus)){ue=t(R[e].amount,T);var de=new Date(R[e].timestamp);me=o((new Date-de)/36e5*60)}for(let e=1;e<R.length;e++)if("TempBasal"==R[e]._type&&R[e].rate>0){N=e,$=R[e].rate;var ce=R[e-1]["duration (min)"]/60,pe=ce,be=new Date(R[e-1].timestamp),fe=be;do{if(e--,0==e){fe=new Date;break}if("TempBasal"==R[e]._type||"PumpSuspend"==R[e]._type){fe=new Date(R[e].timestamp);break}}while(e>0);var ge=(fe-be)/36e5;ge<pe&&(ce=ge),X+=re($*ce),e=N}for(let e=0;e<R.length;e++)if(0,0==R[e]["duration (min)"]||"PumpResume"==R[e]._type){let r=new Date(R[e].timestamp),a=r,t=e;do{if(t>0&&(--t,"TempBasal"==R[t]._type)){a=new Date(R[t].timestamp);break}}while(t>0);(a-r)/36e5>0&&(Z+=oe(a,r))}for(let e=R.length-1;e>0;e--)if("TempBasalDuration"==R[e]._type){let r=R[e]["duration (min)"]/60,a=new Date(R[e].timestamp);var he=a;let t=e;do{if(--t,t>=0&&("TempBasal"==R[t]._type||"PumpSuspend"==R[t]._type)){he=new Date(R[t].timestamp);break}}while(t>0);if(0==e&&"TempBasalDuration"==R[0]._type&&(he=new Date,r=R[e]["duration (min)"]/60),(he-a)/36e5-r>0){Z+=oe(he,ee(a,r))}}var Be={TDD:o(H=Y+X+Z,5),bolus:o(Y,5),temp_basal:o(X,5),scheduled_basal:o(Z,5)},ve=H;k>21?(q=". Bolus insulin: "+Y.toPrecision(5)+" U",L=". Temporary basal insulin: "+X.toPrecision(5)+" U",j=". Insulin with scheduled basal rate: "+Z.toPrecision(5)+" U",z=W+(" TDD past 24h is: "+H.toPrecision(5)+" U")+q+L+j,tddReason=", TDD, 24h: "+o(H,1)+", ytd: "+o(J,1)+", 7dØ: "+o(K,1),console.error(z)):tddReason=", TDD: Not enough pumpData (< 21h)";var _e={},Me=0,Se=0,ye=new Date;if(U&&(ye=new Date(U)),void 0===T||void 0===T.current_basal)return _e.error="Error: could not get current basal rate",_e;var xe=t(T.current_basal,T),Ie=xe,Fe=new Date;U&&(Fe=U);var Te,we=new Date(e.date),De=o((Fe-we)/60/1e3,1),Ge=e.glucose,Ce=e.noise;Te=n(e.delta,T);var Oe=Math.min(e.delta,e.short_avgdelta),Ue=Math.min(e.short_avgdelta,e.long_avgdelta),Re=Math.max(e.delta,e.short_avgdelta,e.long_avgdelta);(Ge<=10||38===Ge||Ce>=3)&&(_e.reason="CGM is calibrating, in ??? state, or noise is high");if(De>12||De<-5?_e.reason="If current system time "+Fe+" is correct, then BG data is too old. The last BG data was read "+De+"m ago at "+we:Ge>60&&e.cgmFlatMinutes>89&&(e.last_cal&&e.last_cal<3?_e.reason="CGM was just calibrated":_e.reason="Error: CGM data was suspiciously flat for the past ~"+o(e.cgmFlatMinutes,1)+"m"),Ge<=10||38===Ge||Ce>=3||De>12||De<-5||Ge>60&&e.cgmFlatMinutes>89)return r.rate>Ie?(_e.reason+=". Replacing high temp basal of "+r.rate+" with neutral temp of "+Ie,_e.deliverAt=ye,_e.temp="absolute",_e.duration=30,_e.rate=Ie,_e):0===r.rate&&r.duration>30?(_e.reason+=". Shortening "+r.duration+"m long zero temp to 30m. ",_e.deliverAt=ye,_e.temp="absolute",_e.duration=30,_e.rate=0,_e):(_e.reason+=". Temp "+r.rate+" <= current basal "+o(Ie,2)+"U/hr; doing nothing. ",_e);var Ae,Pe,Ee,ke,je=T.max_iob;if(void 0!==T.min_bg&&(Pe=T.min_bg),void 0!==T.max_bg&&(Ee=T.max_bg),void 0!==T.enableSMB_high_bg_target&&(ke=T.enableSMB_high_bg_target),void 0===T.min_bg||void 0===T.max_bg)return _e.error="Error: could not determine target_bg. ",_e;Ae=(T.min_bg+T.max_bg)/2;var qe="",Le=T.exercise_mode||T.high_temptarget_raises_sensitivity,We=100,ze=160;T.half_basal_exercise_target&&(ze=T.half_basal_exercise_target),V&&(ze=Q);var Ne=1;if(Le&&T.temptargetSet&&Ae>We||T.low_temptarget_lowers_sensitivity&&T.temptargetSet&&Ae<We){var He=ze-We;sensitivityRatio=He*(He+Ae-We)<=0?T.autosens_max:He/(He+Ae-We),sensitivityRatio=Math.min(sensitivityRatio,T.autosens_max),sensitivityRatio=o(sensitivityRatio,2),Ne=sensitivityRatio,qe=" from TT modifier",g+=", Ratio TT: "+sensitivityRatio,process.stderr.write("Sensitivity ratio set to "+sensitivityRatio+" based on temp target of "+Ae+"; ")}else void 0!==w&&w&&(sensitivityRatio=w.ratio,qe=" from Autosens",process.stderr.write("Autosens ratio: "+sensitivityRatio+"; "));var Xe=Ne;if(sensitivityRatio&&(Ie=T.current_basal*sensitivityRatio,(Ie=t(Ie,T))!==xe?process.stderr.write("Adjusting basal from "+xe+" to "+Ie+"; "):process.stderr.write("Basal unchanged: "+Ie+"; ")),T.temptargetSet);else if(void 0!==w&&w&&(T.sensitivity_raises_target&&w.ratio<1||T.resistance_lowers_target&&w.ratio>1)){Pe=o((Pe-60)/w.ratio)+60,Ee=o((Ee-60)/w.ratio)+60;var Ye=o((Ae-60)/w.ratio)+60;Ae===(Ye=Math.max(80,Ye))?process.stderr.write("target_bg unchanged: "+Ye+"; "):process.stderr.write("target_bg from "+Ae+" to "+Ye+"; "),Ae=Ye}var Ze=200,$e=200,Je=200;if(e.noise>=2){var Ke=Math.max(1.1,T.noisyCGMTargetMultiplier);Math.min(250,T.maxRaw);Ze=o(Math.min(200,Pe*Ke)),$e=o(Math.min(200,Ae*Ke)),Je=o(Math.min(200,Ee*Ke)),process.stderr.write("Raising target_bg for noisy / raw CGM data, from "+Ae+" to "+$e+"; "),Pe=Ze,Ae=$e,Ee=Je}var Qe=.5;T.smb_threshold_ratio>.5&&T.smb_threshold_ratio<=1&&(Qe=T.smb_threshold_ratio);var Ve=Pe-(1-Qe)*(Pe-40);console.log("SMB Threshold set to "+Qe+" - no SMB's applied below "+n(Ve,T));var er=o(T.sens,1),rr=T.sens;void 0!==w&&w&&((rr=o(rr=T.sens/sensitivityRatio,1))!==er?process.stderr.write("ISF from "+n(er,T)+" to "+n(rr,T)):process.stderr.write("ISF unchanged: "+n(rr,T))),console.error("CR: "+T.carb_ratio),console.error("----------------------------------"),console.error(" start autoISF"),console.error("----------------------------------");var ar=!0,tr=!1,or=r.rate,nr=T.b30_duration,ir=nr+1;if(console.error("B30 enabled: "+T.use_B30),T.use_B30&&T.use_autoisf){var sr=T.iTime_Start_Bolus,lr=T.iTime_target,ur=T.b30_upperBG,mr=T.b30_upperdelta,dr=T.b30_factor,cr=!1;T.temptargetSet&&(cr=!0);var pr=me;0==pr&&(pr=1);var br=ue;console.error("B30 last bolus above limit of "+sr+"U was "+br+"U, "+pr+"m ago"),br>=sr&&pr<=nr&&cr&&Ae==lr&&(ir=pr,tr=!0,console.error("B30 iTime is running : "+ir+"m because manual bolus ("+br+") >= Minimum Start Bolus size ("+sr+") and EatingSoon TT set at "+n(lr,T))),console.error("B30 Activation: "+tr),console.error("B30 TTset: "+cr+", at "+Ae+", last Bolus of "+br+"U, "+pr+"m ago. iTime remaining: "+(nr-ir)+"m."),tr&&(e.delta<=mr&&Ge<ur&&(ar=!1),ir<=nr&&(or=t(Ie*dr,T),h="AIMI B30, Temp "+or+"U/hr for "+(nr-ir)+"m, "))}var fr=function(e,r,a,t,i){if(r.use_autoisf&&r.iob_threshold>0&&r.iob_threshold<a[0].iob)return s=", autoISF-SMB disabled:, IOB: "+o(a[0].iob,2)+", > threshold: "+r.iob_threshold+", maxIOB: "+r.max_iob,console.error(s),"iobTH";if(!t)return s=", autoISF-SMB disabled:, B30 running","AIMI B30";if(!e)return"oref";var l=n(r.min_bg,r);if(r.use_autoisf&&r.temptargetSet&&r.enableSMB_EvenOn_OddOff||r.use_autoisf&&r.min_bg==r.max_bg&&r.enableSMB_EvenOn_OddOff_always&&!r.temptargetSet){r.temptargetSet?msgType="TempTarget ":msgType="ProfileTarget ","mmol/L"==r.out_units?(evenTarget=o(10*l,0)%2==0,msgUnits=" has ",msgTail=" decimal"):(evenTarget=l%2==0,msgUnits=" is ",msgTail=" number"),evenTarget?msgEven="even":msgEven="odd";var u=r.iob_threshold_percent;return evenTarget?u/100<a.iob/(r.max_iob*i)?(1!=i?(console.error("Full Loop modified max_iob "+r.max_iob+" to effectively "+o(r.max_iob*i,2)+" due to profile % and/or exercise mode"),B=", effective maxIOB "+o(r.max_iob*i,2)):B=", maxIOB "+r.max_iob,console.error("SMB disabled by Full Loop logic: iob "+a.iob+" is more than "+u+"% of "+B),console.error("Full Loop capped"),"iobTH"):(console.error("SMB enabled - "+msgType+l+msgUnits+msgEven+msgTail),r.temptargetSet&&l<100?(console.error("Loop at full power"),s=", autoISF-SMB enabled:, even TT","fullLoop"):(s=", autoISF-SMB enabled:, even Target",console.error("Loop at medium power"),"enforced")):(console.error("SMB disabled - "+msgType+l+msgUnits+msgEven+msgTail),s=", autoISF-SMB disabled:, odd Target",console.error("Loop at minimum power"),"blocked")}return console.error("Full Loop disabled"),"oref"}(C,T,a,ar,Xe),gr=!0;if(C&&"oref"!=fr?("blocked"!=fr&&"AIMI B30"!=fr||(gr=!1),"enforced"!=fr&&"fullLoop"!=fr||(gr=!0),console.error("loopSMB function overriden with autoISF target toggle, enableSMB = "+gr)):(gr=function(e,r,a,t,o,i){return r?!e.allowSMB_with_high_temptarget&&e.temptargetSet&&o>100?(console.error("SMB disabled due to high temptarget of "+o),!1):!0===a.bwFound&&!1===e.A52_risk_enable?(console.error("SMB disabled due to Bolus Wizard activity in the last 6 hours."),!1):!0===e.enableSMB_always?(a.bwFound?console.error("Warning: SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled due to enableSMB_always"),!0):!0===e.enableSMB_with_COB&&a.mealCOB?(a.bwCarbs?console.error("Warning: SMB enabled with Bolus Wizard carbs: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for COB of"+a.mealCOB),!0):!0===e.enableSMB_after_carbs&&a.carbs?(a.bwCarbs?console.error("Warning: SMB enabled with Bolus Wizard carbs: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for 6h after carb entry"),!0):!0===e.enableSMB_with_temptarget&&e.temptargetSet&&o<100?(a.bwFound?console.error("Warning: SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for temptarget of "+n(o,e)),console.error("SMB enabled for temptargets with "+n(o,e)),!0):!0===e.enableSMB_high_bg&&null!==i&&t>=i?(console.error("Checking BG to see if High for SMB enablement."),console.error("Current BG",t," | High BG ",i),a.bwFound?console.error("Warning: High BG SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("High BG detected. Enabling SMB."),!0):(console.error("SMB disabled (no enableSMB preferences active or no condition satisfied)"),!1):(console.error("SMB disabled (!microBolusAllowed)"),!1)}(T,C,D,Ge,Ae,ke),console.error("loopSMB function returns enableSMB = "+gr)),rr=function(e,r,a,t,g,h,B,T,w,D,G,C){if(!t.use_autoisf)return console.error("autoISF disabled in Preferences"),i+=", autoISF, disabled",e;if(t.autoISF_off_Sport&&(t.high_temptarget_raises_sensitivity||t.exercise_mode)&&t.temptargetSet&&a>C)return console.error("autoISF disabled due to exercise"),i+=", autoISF, disabled (exercise)",e;const O=g.dura_p,U=g.delta_pl,R=g.delta_pn,A=g.r_squ,P=g.bg_acceleration,E=g.a_0,k=g.a_1,j=g.a_2,q=g.dura_ISF_minutes,L=g.dura_ISF_average;t.autoISF_min;var W=t.autoISF_max,z=!1,N=e,H=a+10-g.glucose,X=g.pp_debug;if("bg_acceleration: "+o(P,3)+", PF-minutes: "+O+", PF-corr: "+o(A,4)+", PF-nextDelta: "+n(R,t)+", PF-lastDelta: "+n(U,t)+", regular Delta: "+n(g.delta,t),console.error(X),t.enable_BG_acceleration){var Y=A;if(0!=j&&Y>=.9){var Z=-k/2/j*5,$=o(E-Z*Z/25*j,1);(Z=o(Z,1))>0&&P<0?(p="predicts a Max of "+n($,t)+", in about "+Math.abs(Z)+"min",console.error("Parabolic fit "+p)):Z>0&&P>0?(p="predicts a Min of "+n($,t)+", in about "+Math.abs(Z)+"min",console.error("Parabolic fit "+p),Z<=30&&$<a&&(_=-t.bgBrake_ISF_weight,p="predicts BG below target soon, applying bgBrake ISF weight of "+-_,console.error("Parabolic fit "+p))):Z<0&&P<0?(p="saw Max of "+n($,t)+", about "+Math.abs(Z)+"min ago",console.error("Parabolic fit "+p)):Z<0&&P>0&&(p="saw Min of "+n($,t)+", about "+Math.abs(Z)+"min ago",console.error("Parabolic fit "+p))}if(Y<.9)p="acce_ISF by-passed, as correlation, "+o(Y,2)+", is too low",console.error("Parabolic fit "+p),d+=", Parabolic Fit, "+p;else{var J=10*(Y-.9),K=1;1==_&&g.glucose<t.target_bg?P>0?(P>1&&(K=.5),_=t.bgBrake_ISF_weight):P<0&&(_=t.bgAccel_ISF_weight):1==_&&(P<0?_=t.bgBrake_ISF_weight:P>0&&(_=t.bgAccel_ISF_weight)),(v=1+P*K*_*J)<0&&(v=.1),console.error(d+"acce_ISF adaptation is "+o(v,2)),1!=v&&(z=!0,d+=", Parabolic Fit, "+p+", acce-ISF Ratio: "+o(v,2))}}else console.error("autoISF BG accelertion adaption disabled in Preferences");i+=s+d+", autoISF",M=1+I(100-H,t,"bg"),console.error("bg_ISF adaptation is "+o(M,2));var Q=1,V=1;if(M<1)return Q=Math.min(M,v),v>1?(c="bg-ISF adaptation lifted to "+o(Q=M*v,2)+", as BG accelerates already",console.error(c),i+=", bg-ISF Ratio: "+o(Q,2)+"(accel.)"):i+=", bg-ISF Ratio: "+o(Q,2)+"(minimal)",V=F(Q,t.autoISF_min,W,w,r,t,G,a,C),N=Math.min(720,o(t.sens/V,1)),i+=", bg-ISF Ratio: "+o(V,2),N;M>1&&(z=!0,i+=", bg-ISF Ratio: "+o(M,2));var ee=g.delta;t.enable_pp_ISF_always||t.pp_ISF_hours>=(B-h.lastCarbTime)/1e3/3600?deltaType="pp":deltaType="delta",H>0?console.error(deltaType+"_ISF adaptation by-passed as average glucose < "+a+"+10"):g.short_avgdelta<0?console.error(deltaType+"_ISF adaptation by-passed as no rise or too short lived"):"pp"==deltaType?(y=1+Math.max(0,ee*t.pp_ISF_weight),console.error("pp_ISF adaptation is "+o(y,2)),u=", pp-ISF Ratio: "+o(y,2),1!=y&&(z=!0)):(S=I(ee,t,"delta"),H>-20&&(S*=.5),S=1+S,console.error("delta_ISF adaptation is "+o(S,2)),m=", Δ-ISF Ratio: "+o(S,2),1!=S&&(z=!0));var re=t.dura_ISF_weight;h.mealCOB>0&&!t.enableautoisf_with_COB?console.error("dura_ISF by-passed; preferences disabled mealCOB of "+o(h.mealCOB,1)):q<10?console.error("dura_ISF by-passed; BG is only "+q+"m at level "+L):L<=a?console.error("dura_ISF by-passed; avg. glucose "+L+" below target "+n(a,t)):(x+=q/60*(re/a)*(L-a),z=!0,l=", Duration: "+q+", Avg: "+n(L,t)+", dura-ISF Ratio: "+o(x,2),console.error("dura_ISF adaptation is "+o(x,2)+" because ISF "+e+" did not do it for "+o(q,1)+"m"));return z?(Q=Math.max(x,M,S,v,y),console.error("autoISF adaption ratios:"),console.error("  acce "+o(v,2)),console.error("  bg "+o(M,2)),console.error("  dura "+o(x,2)),console.error("  pp "+o(y,2)),console.error("  delta "+o(S,2)),v<1&&(c="strongest autoISF factor "+o(Q,2)+" weakened to "+o(Q*v,2)+" as bg decelerates already",console.error(c),Q*=v),V=F(Q,t.autoISF_min,W,w,r,t,G,a,C),N=o(t.sens/V,1),i+=u+m+l+", final Ratio: "+o(V,2)+f+b+", final ISF: "+n(t.sens,t)+"→"+n(N,t),N):(i+=", not modified",console.error("autoISF does not modify"),N)}(rr,qe,Ae,T,e,D,U,0,sensitivityRatio,0,Le,We),console.error("----------------------------------"),console.error(" end autoISF"),console.error("----------------------------------"),void 0===a)return _e.error="Error: iob_data undefined. ",_e;var hr,Br=a;if(a.length,a.length>1&&(a=Br[0]),void 0===a.activity||void 0===a.iob)return _e.error="Error: iob_data missing some property. ",_e;var vr=((hr=void 0!==a.lastTemp?o((new Date(Fe).getTime()-a.lastTemp.date)/6e4):0)+r.duration)%30;if(console.error("currenttemp:"+r.rate+" lastTempAge:"+hr+"m, tempModulus:"+vr+"m"),_e.temp="absolute",_e.deliverAt=ye,C&&r&&a.lastTemp&&r.rate!==a.lastTemp.rate&&hr>10&&r.duration)return _e.reason="Warning: currenttemp rate "+r.rate+" != lastTemp rate "+a.lastTemp.rate+" from pumphistory; canceling temp",G.setTempBasal(0,0,T,_e,r);if(r&&a.lastTemp&&r.duration>0){var _r=hr-a.lastTemp.duration;if(_r>5&&hr>10)return _e.reason="Warning: currenttemp running but lastTemp from pumphistory ended "+_r+"m ago; canceling temp",G.setTempBasal(0,0,T,_e,r)}var Mr=o(-a.activity*rr*5,2),Sr=o(6*(Oe-Mr));Sr<0&&(Sr=o(6*(Ue-Mr)))<0&&(Sr=o(6*(e.long_avgdelta-Mr)));var yr=Ge,xr=(yr=a.iob>0?o(Ge-a.iob*rr):o(Ge-a.iob*Math.min(rr,T.sens)))+Sr;if(void 0===xr||isNaN(xr))return _e.error="Error: could not calculate eventualBG. Sensitivity: "+rr+" Deviation: "+Sr,_e;var Ir=function(e,r,a){return o(a+(e-r)/24,1)}(Ae,xr,Mr);_e={temp:"absolute",bg:n(Ge,T),tick:Te,eventualBG:xr,insulinReq:0,reservoir:O,deliverAt:ye,sensitivityRatio,TDD:ve,insulin:Be};var Fr=[],Tr=[],wr=[],Dr=[];Fr.push(Ge),Tr.push(Ge),Dr.push(Ge),wr.push(Ge);var Gr=T.enableUAM,Cr=0,Or=0;Cr=o(Oe-Mr,1);var Ur=o(Oe-Mr,1);csf=rr/T.carb_ratio,console.error("profile.sens:"+n(T.sens,T)+", sens:"+n(rr,T)+", CSF:"+o(csf,1));var Rr=o(30*csf*5/60,1);Cr>Rr&&(console.error("Limiting carb impact from "+Cr+" to "+Rr+"mg/dL/5m (30g/h)"),Cr=Rr);var Ar=3;sensitivityRatio&&(Ar/=sensitivityRatio);var Pr=Ar;if(D.carbs){Ar=Math.max(Ar,D.mealCOB/20);var Er=o((new Date(Fe).getTime()-D.lastCarbTime)/6e4),kr=(D.carbs-D.mealCOB)/D.carbs;Pr=o(Pr=Ar+1.5*Er/60,1),console.error("Last carbs "+Er+" minutes ago; remainingCATime:"+Pr+"hours; "+o(100*kr)+"% carbs absorbed")}var jr=Math.max(0,Cr/5*60*Pr/2)/csf,qr=90,Lr=1;T.remainingCarbsCap&&(qr=Math.min(90,T.remainingCarbsCap)),T.remainingCarbsFraction&&(Lr=Math.min(1,T.remainingCarbsFraction));var Wr=1-Lr,zr=Math.max(0,D.mealCOB-jr-D.carbs*Wr),Nr=(zr=Math.min(qr,zr))*csf*5/60/(Pr/2),Hr=o(D.slopeFromMaxDeviation,2),Xr=o(D.slopeFromMinDeviation,2),Yr=Math.min(Hr,-Xr/3),Zr=0;0===Cr?Or=0:!0===T.floating_carbs?(Or=Math.min(60*Pr/5/2,Math.max(0,D.carbs*csf/Cr)),Zr=Math.min(60*Pr/5/2,Math.max(0,D.mealCOB*csf/Cr)),D.carbs>0&&(i+=", Floating Carbs:, CID: "+o(Or,1)+", MealCarbs: "+o(D.carbs,1)+", Not Floating:, CID: "+o(Zr,1)+", MealCOB: "+o(D.mealCOB,1),console.error("Floating Carbs CID: "+o(Or,1)+" / MealCarbs: "+o(D.carbs,1)+" vs. Not Floating:"+o(Zr,1)+" / MealCOB:"+o(D.mealCOB,1)))):Or=Math.min(60*Pr/5/2,Math.max(0,D.mealCOB*csf/Cr)),console.error("Carb Impact:"+Cr+"mg/dL per 5m; CI Duration:"+o(5*Or/60*2,1)+"hours; remaining CI ("+o(Pr/2,2)+"h peak):",o(Nr,1)+"mg/dL per 5m");var $r,Jr,Kr,Qr,Vr,ea=999,ra=999,aa=999,ta=Ge,oa=999,na=999,ia=999,sa=999,la=xr,ua=Ge,ma=Ge,da=0,ca=[],pa=[];try{Br.forEach((function(e){var r=o(-e.activity*rr*5,2),a=o(-e.iobWithZeroTemp.activity*rr*5,2),t=Cr*(1-Math.min(1,Tr.length/12));la=Tr[Tr.length-1]+r+t;var n=Dr[Dr.length-1]+a,i=Math.max(0,Math.max(0,Cr)*(1-Fr.length/Math.max(2*Or,1))),s=Math.min(Fr.length,12*Pr-Fr.length),l=Math.max(0,s/(Pr/2*12)*Nr);i+l,ca.push(o(l,0)),pa.push(o(i,0)),COBpredBG=Fr[Fr.length-1]+r+Math.min(0,t)+i+l;var u=Math.max(0,Ur+wr.length*Yr),m=Math.max(0,Ur*(1-wr.length/Math.max(36,1))),d=Math.min(u,m);d>0&&(da=o(5*(wr.length+1)/60,1)),UAMpredBG=wr[wr.length-1]+r+Math.min(0,t)+d,Tr.length<48&&Tr.push(la),Fr.length<48&&Fr.push(COBpredBG),wr.length<48&&wr.push(UAMpredBG),Dr.length<48&&Dr.push(n),COBpredBG<oa&&(oa=o(COBpredBG)),UAMpredBG<na&&(na=o(UAMpredBG)),la<ia&&(ia=o(la)),n<sa&&(sa=o(n));Tr.length>18&&la<ea&&(ea=o(la)),la>ua&&(ua=la),(Or||Nr>0)&&Fr.length>18&&COBpredBG<ra&&(ra=o(COBpredBG)),(Or||Nr>0)&&COBpredBG>ua&&(ma=COBpredBG),Gr&&wr.length>12&&UAMpredBG<aa&&(aa=o(UAMpredBG)),Gr&&UAMpredBG>ua&&UAMpredBG}))}catch(e){console.error("Problem with iobArray.  Optional feature Advanced Meal Assist disabled")}_e.predBGs={},Tr.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))}));for(var ba=Tr.length-1;ba>12&&Tr[ba-1]===Tr[ba];ba--)Tr.pop();for(_e.predBGs.IOB=Tr,Kr=o(Tr[Tr.length-1]),Dr.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),ba=Dr.length-1;ba>6&&!(Dr[ba-1]>=Dr[ba]||Dr[ba]<=Ae);ba--)Dr.pop();if(_e.predBGs.ZT=Dr,o(Dr[Dr.length-1]),D.mealCOB>0&&(Cr>0||Nr>0)){for(Fr.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),ba=Fr.length-1;ba>12&&Fr[ba-1]===Fr[ba];ba--)Fr.pop();_e.predBGs.COB=Fr,Qr=o(Fr[Fr.length-1]),xr=Math.max(xr,o(Fr[Fr.length-1]))}if(Cr>0||Nr>0){if(Gr){for(wr.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),ba=wr.length-1;ba>12&&wr[ba-1]===wr[ba];ba--)wr.pop();_e.predBGs.UAM=wr,Vr=o(wr[wr.length-1]),wr[wr.length-1]&&(xr=Math.max(xr,o(wr[wr.length-1])))}_e.eventualBG=xr}console.error("UAM Impact:"+Ur+"mg/dL per 5m; UAM Duration:"+da+"hours"),ea=Math.max(39,ea),ra=Math.max(39,ra),aa=Math.max(39,aa),$r=o(ea);var fa=D.mealCOB/D.carbs;Jr=o(aa<999&&ra<999?(1-fa)*UAMpredBG+fa*COBpredBG:ra<999?(la+COBpredBG)/2:aa<999?(la+UAMpredBG)/2:la),sa>Jr&&(Jr=sa),ta=o(ta=Or||Nr>0?Gr?fa*oa+(1-fa)*na:oa:Gr?na:ia);var ga=aa;if(sa<Ve)ga=(aa+sa)/2;else if(sa<Ae){var ha=(sa-Ve)/(Ae-Ve);ga=(aa+(aa*ha+sa*(1-ha)))/2}else sa>aa&&(ga=(aa+sa)/2);if(ga=o(ga),D.carbs)if(!Gr&&ra<999)$r=o(Math.max(ea,ra));else if(ra<999){var Ba=fa*ra+(1-fa)*ga;$r=o(Math.max(ea,ra,Ba))}else $r=Gr?ga:ta;else Gr&&($r=o(Math.max(ea,ga)));$r=Math.min($r,Jr),process.stderr.write("minPredBG: "+n($r,T)+" minIOBPredBG: "+n(ea,T)+" minZTGuardBG: "+n(sa,T)),ra<999&&process.stderr.write(" minCOBPredBG: "+n(ra,T)),aa<999&&process.stderr.write(" minUAMPredBG: "+n(aa,T)),console.error(" avgPredBG:"+n(Jr,T)+" COB/Carbs:"+D.mealCOB+"/"+D.carbs),ma>Ge&&($r=Math.min($r,ma)),_e.COB=D.mealCOB,_e.IOB=a.iob,_e.BGI=n(Mr,T),_e.deviation=n(Sr,T),_e.dura_ISFratio=o(x,2),_e.bg_ISFratio=o(M,2),_e.delta_ISFratio=o(S,2),_e.pp_ISFratio=o(y,2),_e.acce_ISFratio=o(v,2),_e.auto_ISFratio=o(T.sens/rr,2),_e.ISF=n(rr,T),_e.CR=o(T.carb_ratio,2),_e.TDD=o(ve,1),_e.TDDytd=o(J,1),_e.TDD7d=o(K,1),_e.target_bg=n(Ae,T),_e.minDelta=Oe,_e.expectedDelta=Ir,_e.minGuardBG=ta,_e.minPredBG=$r;var va=function(e,r,a,t){if(!e.use_autoisf)return console.error("autoISF disabled, don't adjust SMB Delivery Ratio"),.5;var n=e.smb_delivery_ratio_bg_range;n<10&&(n/=.0555);var i=e.smb_delivery_ratio,s=Math.min(e.smb_delivery_ratio_min,e.smb_delivery_ratio_max),l=Math.max(e.smb_delivery_ratio_min,e.smb_delivery_ratio_max),u=a+n,m=i;return n>0&&(m=s+(l-s)*(r-a)/n,m=Math.max(s,Math.min(l,m))),"fullLoop"==t?(console.error("SMB delivery ratio set to "+o(Math.max(i,m),2)+" as max of fixed and interpolated values"),Math.max(i,m)):0==n?(console.error("SMB delivery ratio set to fixed value "+o(i,2)),i):r<=a?(console.error("SMB delivery ratio limited by minimum value "+o(s,2)),s):r>=u?(console.error("SMB delivery ratio limited by maximum value "+o(l,2)),l):(console.error("SMB delivery ratio set to interpolated value "+o(m,2)),m)}(T,Ge,Ae,fr);_e.SMBratio=o(va,2);var _a="SMB Del.Ratio:, "+o(va,2);_e.reason=h+_a+g+i+", Standard, COB: "+_e.COB+", Dev: "+_e.deviation+", BGI: "+_e.BGI+", ISF: "+_e.ISF+", CR: "+_e.CR+", Target: "+_e.target_bg+", minPredBG "+n($r,T)+", minGuardBG "+n(ta,T)+", IOBpredBG "+n(Kr,T),Qr>0&&(_e.reason+=", COBpredBG "+n(Qr,T)),Vr>0&&(_e.reason+=", UAMpredBG "+n(Vr,T)),_e.reason+=tddReason,_e.reason+="; ";var Ma=yr;Ma<40&&(Ma=Math.min(ta,Ma));var Sa=Ve-Ma,ya=240,xa=240;if(D.mealCOB>0&&(Cr>0||Nr>0)){for(ba=0;ba<Fr.length;ba++)if(Fr[ba]<Pe){ya=5*ba;break}for(ba=0;ba<Fr.length;ba++)if(Fr[ba]<Ve){xa=5*ba;break}}else{for(ba=0;ba<Tr.length;ba++)if(Tr[ba]<Pe){ya=5*ba;break}for(ba=0;ba<Tr.length;ba++)if(Tr[ba]<Ve){xa=5*ba;break}}gr&&ta<Ve&&(console.error("minGuardBG "+n(ta,T)+" projected below "+n(Ve,T)+" - disabling SMB"),Se=1,Me=o((xr-Ae)/rr,2),gr=!1);var Ia=.2;"fullLoop"==fr&&(Ia=.3),Re>Ia*Ge&&(console.error("maxDelta "+n(Re,T)+" > "+100*Ia+"% of BG "+n(Ge,T)+" - disabling SMB"),_e.reason+="maxDelta "+n(Re,T)+" > "+100*Ia+"% of BG "+n(Ge,T)+" - SMB disabled!, ",gr=!1),console.error("BG projected to remain above "+n(Pe,T)+" for "+ya+"minutes"),(xa<240||ya<60)&&console.error("BG projected to remain above "+n(Ve,T)+" for "+xa+"minutes");var Fa=xa,Ta=T.current_basal*rr*Fa/60,wa=Math.max(0,D.mealCOB-.25*D.carbs),Da=(Sa-Ta)/csf-wa;if(Ta=o(Ta),Da=o(Da),console.error("naive_eventualBG: "+n(yr,T)+", bgUndershoot: "+n(Sa,T)+", zeroTempDuration: "+Fa+", zeroTempEffect: "+Ta+", carbsReq: "+Da),"Could not parse clock data"==D.reason?console.error("carbsReq unknown: Could not parse clock data"):Da>=T.carbsReqThreshold&&xa<=45&&(_e.carbsReq=Da,_e.reason+=Da+" add'l carbs req w/in "+xa+"m; "),tr&&ir<=nr)return _e.reason+="setting AIMI B30 Temp "+t(or,T)+"U/hr for "+(nr-ir)+"m ",_e.temp="absolute",_e.deliverAt=ye,_e.duration=Math.min(30,nr-ir),console.error("Forcing AIMI temp "+or+"U/hr"),G.setTempBasal(or,30,T,_e,r);var Ga=0;if(Ge<Ve&&a.iob<20*-T.current_basal/60&&Oe>0&&Oe>Ir)_e.reason+="IOB "+a.iob+" < "+o(20*-T.current_basal/60,2),_e.reason+=" and minDelta "+n(Oe,T)+" > expectedDelta "+n(Ir,T)+"; ";else if(Ge<Ve||ta<Ve)return _e.reason+="minGuardBG "+n(ta,T)+"<"+n(Ve,T),ta<Ve&&(Se=2),Me=o((xr-Ae)/rr,2),Ga=o(60*((Sa=Ae-ta)/rr)/T.current_basal),Ga=30*o(Ga/30),Ga=Math.min(120,Math.max(30,Ga)),G.setTempBasal(0,Ga,T,_e,r);if(T.skip_neutral_temps&&_e.deliverAt.getMinutes()>=55){if(!gr)return _e.reason+="; Canceling temp at "+(60-_e.deliverAt.getMinutes())+"min before turn of the hour to avoid beeping of MDT. SMB disabled anyways.",G.setTempBasal(0,0,T,_e,r);console.error(60-_e.deliverAt.getMinutes()+"min before turn of the hour, but SMB's are enabled - no skipping neutral temps")}var Ca=0,Oa=Ie;if(xr<Pe){if(_e.reason+="Eventual BG "+n(xr,T)+" < "+n(Pe,T),Oe>Ir&&Oe>0&&!Da)return yr<40?(_e.reason+=", naive_eventualBG < 40. ",G.setTempBasal(0,30,T,_e,r)):(e.delta>Oe?_e.reason+=", but Delta "+n(Te,T)+" > expectedDelta "+n(Ir,T):_e.reason+=", but Min. Delta "+Oe.toFixed(2)+" > Exp. Delta "+n(Ir,T),r.duration>15&&t(Ie,T)===t(r.rate,T)?(_e.reason+=", temp "+r.rate+" ~ req "+Ie+"U/hr. ",_e):(_e.reason+="; setting current basal of "+Ie+" as temp. ",G.setTempBasal(Ie,30,T,_e,r)));Ca=o(Ca=2*Math.min(0,(xr-Ae)/rr),2);var Ua=Math.min(0,(yr-Ae)/rr);if(Ua=o(Ua,2),Oe<0&&Oe>Ir)Ca=o(Ca*(Oe/Ir),2);if(Oa=t(Oa=Ie+2*Ca,T),r.duration*(r.rate-Ie)/60<Math.min(Ca,Ua)-.3*Ie)return _e.reason+=", "+r.duration+"m@"+r.rate.toFixed(2)+" is a lot less than needed. ",G.setTempBasal(Oa,30,T,_e,r);if(void 0!==r.rate&&r.duration>5&&Oa>=.8*r.rate)return _e.reason+=", temp "+r.rate+" ~< req "+Oa+"U/hr. ",_e;if(Oa<=0){if((Ga=o(60*((Sa=Ae-yr)/rr)/T.current_basal))<0?Ga=0:(Ga=30*o(Ga/30),Ga=Math.min(120,Math.max(0,Ga))),Ga>0)return _e.reason+=", setting "+Ga+"m zero temp. ",G.setTempBasal(Oa,Ga,T,_e,r)}else _e.reason+=", setting "+Oa+"U/hr. ";return G.setTempBasal(Oa,30,T,_e,r)}if(Oe<Ir&&(_e.minDelta=Oe,_e.expectedDelta=Ir,(Ir-Oe>=2||Ir+-1*Oe>=2)&&(Se=Oe>=0&&Ir>0?3:Oe<0&&Ir<=0||Oe<0&&Ir>=0?4:5),Me=o((xr-Ae)/rr,2),!C||!gr))return e.delta<Oe?_e.reason+="Eventual BG "+n(xr,T)+" > "+n(Pe,T)+" but Delta "+n(Te,T)+" < Exp. Delta "+n(Ir,T):_e.reason+="Eventual BG "+n(xr,T)+" > "+n(Pe,T)+" but Min. Delta "+Oe.toFixed(2)+" < Exp. Delta "+n(Ir,T),r.duration>15&&t(Ie,T)===t(r.rate,T)?(_e.reason+=", temp "+r.rate+" ~ req "+Ie+"U/hr. ",_e):(_e.reason+="; setting current basal of "+Ie+" as temp. ",G.setTempBasal(Ie,30,T,_e,r));if(Math.min(xr,$r)<Ee&&($r<Pe&&xr>Pe&&(Se=6,Me=o((xr-Ae)/rr,2)),!C||!gr))return _e.reason+=n(xr,T)+"-"+n($r,T)+" in range: no temp required",r.duration>15&&t(Ie,T)===t(r.rate,T)?(_e.reason+=", temp "+r.rate+" ~ req "+Ie+"U/hr. ",_e):(_e.reason+="; setting current basal of "+Ie+" as temp. ",G.setTempBasal(Ie,30,T,_e,r));if(xr>=Ee&&(_e.reason+="Eventual BG "+n(xr,T)+" >= "+n(Ee,T)+", "),a.iob>je)return _e.reason+="IOB "+o(a.iob,2)+" > max_iob "+je,r.duration>15&&t(Ie,T)===t(r.rate,T)?(_e.reason+=", temp "+r.rate+" ~ req "+Ie+"U/hr. ",_e):(_e.reason+="; setting current basal of "+Ie+" as temp. ",G.setTempBasal(Ie,30,T,_e,r));Ca=o((Math.min($r,xr)-Ae)/rr,2),Me=o((xr-Ae)/rr,2),Ca>je-a.iob?(_e.reason+="max_iob "+je+", ",console.error("InsReq",o(Ca,2),"capped at "+o(je-a.iob,2)+" to not exceed max_iob"),Ca=je-a.iob):console.error("SMB not limited by maxIOB ( insulinReq: "+Ca+" U)."),Me>je-a.iob?(console.error("Ev. Bolus limited by maxIOB: "+je-a.iob+" (. insulinForManualBolus: "+Me+" U)"),_e.reason+="max_iob "+je+", "):console.error("Ev. Bolus would not be limited by maxIOB ( insulinForManualBolus: "+Me+" U)."),Oa=t(Oa=Ie+2*Ca,T),Ca=o(Ca,3),_e.insulinReq=Ca,_e.insulinForManualBolus=o(Me,2),_e.manualBolusErrorString=Se,_e.minDelta=Oe,_e.expectedDelta=Ir,_e.minGuardBG=ta,_e.minPredBG=$r,_e.threshold=n(Ve,T),_e.reason="Ins.Req: "+o(Ca,2)+", "+_e.reason;var Ra=o((new Date(Fe).getTime()-a.lastBolusTime)/6e4,1);if(C&&gr&&Ge>Ve){var Aa=o(D.mealCOB/T.carb_ratio,3);if(T.use_autoisf)Pa=T.smb_max_range_extension;else{console.error("autoISF disabled, SMB range extension disabled");var Pa=1}Pa>1&&console.error("SMB max range extended from default by factor "+Pa);var Ea=0;void 0===T.maxSMBBasalMinutes?(Ea=o(Pa*T.current_basal*30/60,1),console.error("profile.maxSMBBasalMinutes undefined: defaulting to 30m")):a.iob>Aa&&a.iob>0?(console.error("IOB",a.iob,"> COB",D.mealCOB+"; mealInsulinReq =",Aa),T.maxUAMSMBBasalMinutes?(console.error("profile.maxUAMSMBBasalMinutes:",T.maxUAMSMBBasalMinutes,"profile.current_basal:",T.current_basal),Ea=o(Pa*T.current_basal*T.maxUAMSMBBasalMinutes/60,1)):(console.error("profile.maxUAMSMBBasalMinutes undefined: defaulting to 30m"),Ea=o(30*T.current_basal/60,1))):(console.error("profile.maxSMBBasalMinutes:",T.maxSMBBasalMinutes,"profile.current_basal:",T.current_basal),Ea=o(Pa*T.current_basal*T.maxSMBBasalMinutes/60,1));var ka=T.bolus_increment,ja=1/ka;T.use_autoisf||(console.error("autoISF disabled, don't adjust SMB Delivery Ratio"),va=.5),va>.5&&console.error("SMB Delivery Ratio increased from default 0.5 to "+o(va,2));var qa=Math.min(Ca*va,Ea),La=T.iob_threshold_percent/100*130/100*T.max_iob*Xe;qa>La-a.iob&&("fullLoop"==fr||"enforced"==fr)&&(qa=La-a.iob,console.error("autoISF capped SMB at "+o(qa,2)+" to not exceed 130% of effective iobTH "+o(La/130*100,2)+"U")),qa=Math.floor(qa*ja)/ja,Ga=o(60*((Ae-(yr+ea)/2)/rr)/T.current_basal),Ca>0&&qa<ka&&(Ga=0);var Wa=0;Ga<=0?Ga=0:Ga>=30?(Ga=30*o(Ga/30),Ga=Math.min(60,Math.max(0,Ga))):(Wa=o(Ie*Ga/30,2),Ga=30),_e.reason+=" insulinReq "+Ca,qa>=Ea&&(_e.reason+="; maxBolus "+Ea),Ga>0&&(_e.reason+="; setting "+Ga+"m low temp of "+Wa+"U/h"),_e.reason+=". ";var za=3;T.SMBInterval&&(za=Math.min(10,Math.max(1,T.SMBInterval)));var Na=o(za-Ra,0),Ha=o(60*(za-Ra),0)%60;if(console.error("naive_eventualBG "+n(yr,T)+", "+Ga+"m "+Wa+"U/h temp needed; last bolus "+Ra+"m ago; maxBolus: "+Ea),Ra>za?qa>0&&(_e.units=qa,_e.reason+="Microbolusing "+qa+"U. "):_e.reason+="Waiting "+Na+"m "+Ha+"s to microbolus again. ",Ga>0)return _e.rate=Wa,_e.duration=Ga,_e}var Xa=G.getMaxSafeBasal(T);return Oa>Xa&&(_e.reason+="adj. req. rate: "+o(Oa,2)+" to maxSafeBasal: "+o(Xa,2)+", ",Oa=t(Xa,T)),r.duration*(r.rate-Ie)/60>=2*Ca?(_e.reason+=r.duration+"m@"+r.rate.toFixed(2)+" > 2 * insulinReq. Setting temp basal of "+Oa+"U/hr. ",G.setTempBasal(Oa,30,T,_e,r)):void 0===r.duration||0===r.duration?(_e.reason+="no temp, setting "+Oa+"U/hr. ",G.setTempBasal(Oa,30,T,_e,r)):r.duration>5&&t(Oa,T)<=t(r.rate,T)?(_e.reason+="temp "+r.rate+" >~ req "+Oa+"U/hr. ",_e):(_e.reason+="temp "+r.rate+"<"+Oa+"U/hr. ",G.setTempBasal(Oa,30,T,_e,r))}},6880:(e,r,a)=>{var t=a(6654);e.exports=function(e,r){var a=20;void 0!==r&&"string"==typeof r.model&&(t(r.model,"54")||t(r.model,"23"))&&(a=40);return e<1?Math.round(e*a)/a:e<10?Math.round(20*e)/20:Math.round(10*e)/10}},2705:(e,r,a)=>{var t=a(5639).Symbol;e.exports=t},9932:e=>{e.exports=function(e,r){for(var a=-1,t=null==e?0:e.length,o=Array(t);++a<t;)o[a]=r(e[a],a,e);return o}},9750:e=>{e.exports=function(e,r,a){return e==e&&(void 0!==a&&(e=e<=a?e:a),void 0!==r&&(e=e>=r?e:r)),e}},4239:(e,r,a)=>{var t=a(2705),o=a(9607),n=a(2333),i=t?t.toStringTag:void 0;e.exports=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":i&&i in Object(e)?o(e):n(e)}},531:(e,r,a)=>{var t=a(2705),o=a(9932),n=a(1469),i=a(3448),s=t?t.prototype:void 0,l=s?s.toString:void 0;e.exports=function e(r){if("string"==typeof r)return r;if(n(r))return o(r,e)+"";if(i(r))return l?l.call(r):"";var a=r+"";return"0"==a&&1/r==-Infinity?"-0":a}},7561:(e,r,a)=>{var t=a(7990),o=/^\s+/;e.exports=function(e){return e?e.slice(0,t(e)+1).replace(o,""):e}},1957:(e,r,a)=>{var t="object"==typeof a.g&&a.g&&a.g.Object===Object&&a.g;e.exports=t},9607:(e,r,a)=>{var t=a(2705),o=Object.prototype,n=o.hasOwnProperty,i=o.toString,s=t?t.toStringTag:void 0;e.exports=function(e){var r=n.call(e,s),a=e[s];try{e[s]=void 0;var t=!0}catch(e){}var o=i.call(e);return t&&(r?e[s]=a:delete e[s]),o}},2333:e=>{var r=Object.prototype.toString;e.exports=function(e){return r.call(e)}},5639:(e,r,a)=>{var t=a(1957),o="object"==typeof self&&self&&self.Object===Object&&self,n=t||o||Function("return this")();e.exports=n},7990:e=>{var r=/\s/;e.exports=function(e){for(var a=e.length;a--&&r.test(e.charAt(a)););return a}},6654:(e,r,a)=>{var t=a(9750),o=a(531),n=a(554),i=a(9833);e.exports=function(e,r,a){e=i(e),r=o(r);var s=e.length,l=a=void 0===a?s:t(n(a),0,s);return(a-=r.length)>=0&&e.slice(a,l)==r}},1469:e=>{var r=Array.isArray;e.exports=r},3218:e=>{e.exports=function(e){var r=typeof e;return null!=e&&("object"==r||"function"==r)}},7005:e=>{e.exports=function(e){return null!=e&&"object"==typeof e}},3448:(e,r,a)=>{var t=a(4239),o=a(7005);e.exports=function(e){return"symbol"==typeof e||o(e)&&"[object Symbol]"==t(e)}},8601:(e,r,a)=>{var t=a(4841),o=1/0;e.exports=function(e){return e?(e=t(e))===o||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}},554:(e,r,a)=>{var t=a(8601);e.exports=function(e){var r=t(e),a=r%1;return r==r?a?r-a:r:0}},4841:(e,r,a)=>{var t=a(7561),o=a(3218),n=a(3448),i=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,l=/^0o[0-7]+$/i,u=parseInt;e.exports=function(e){if("number"==typeof e)return e;if(n(e))return NaN;if(o(e)){var r="function"==typeof e.valueOf?e.valueOf():e;e=o(r)?r+"":r}if("string"!=typeof e)return 0===e?e:+e;e=t(e);var a=s.test(e);return a||l.test(e)?u(e.slice(2),a?2:8):i.test(e)?NaN:+e}},9833:(e,r,a)=>{var t=a(531);e.exports=function(e){return null==e?"":t(e)}}},r={};function a(t){var o=r[t];if(void 0!==o)return o.exports;var n=r[t]={exports:{}};return e[t](n,n.exports,a),n.exports}a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}();var t=a(5546);freeaps_determineBasal=t})();